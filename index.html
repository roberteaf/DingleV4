<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Space Mines & Plinko</title>
  <style>
    :root {
      --bg1: #a0eaff;
      --bg2: #ff9aa2;
      --accent: #7af0c2;
      --muted: #8fa3b3;
      --card-bg: #0b0d18;
      --glass: rgba(255,255,255,0.02);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height:100%; }
    body {
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      background-size: 400% 400%;
      animation: bgShift 20s ease infinite;
      color: #e6eef8;
      min-height:100vh;
      font-family: Inter, system-ui, sans-serif;
    }
    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .topbar {
      position:fixed;
      top:18px; left:18px;
      z-index:10;
      display:flex;
      gap:10px;
    }
    .switch-btn {
      background: var(--card-bg);
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 10px 18px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: background 0.2s, color 0.2s;
    }
    .switch-btn.active {
      background: var(--accent);
      color: #0b0d18;
    }
    .container {
      width:100%;
      max-width:1000px;
      margin:80px auto 0 auto;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:20px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)), var(--card-bg);
      border-radius:12px;
      padding:18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .hidden { display:none !important; }
    /* Mines game styles */
    .balance {
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .balance .amount {
      font-size:28px;
      font-weight:700;
      color: var(--accent);
    }
    .balance .label {
      color: var(--muted);
      font-size:13px;
    }
    input[type=number], input[type=text], input[type=password] {
      width:140px;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:transparent;
      color:inherit;
      font-weight:600;
      transition: border-color 0.3s;
    }
    input[type=number]:focus, input[type=text]:focus, input[type=password]:focus {
      border-color: var(--accent);
      outline: none;
    }
    button {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:inherit;
      border:1px solid rgba(255,255,255,0.04);
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 22px rgba(0,0,0,0.7);
    }
    .btn-primary {
      background: linear-gradient(90deg, var(--accent), #a0f9d8);
      border:none;
      color:#0b0d18;
      box-shadow: 0 6px 18px rgba(122,240,194,0.2);
    }
    .toggle {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px;
      border-radius:10px;
      background: var(--glass);
      border:1px solid rgba(255,255,255,0.02);
    }
    .toggle input {
      width:16px; height:16px;
    }
    .toggle span {
      color: var(--muted);
      font-size:13px;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(5,1fr);
      gap:6px;
      margin-top:12px;
    }
    .cell {
      position: relative;
      background: var(--glass);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
      user-select:none;
      aspect-ratio:1;
      overflow:hidden;
      transition: background 0.3s;
    }
    .cell:hover {
      background: rgba(255,255,255,0.06);
    }
    .cell.revealed {
      cursor: default;
      background: rgba(255,255,255,0.08);
    }
    .cell.mine {
      background: linear-gradient(135deg, #001a33, #004f66);
      color: #ff6666;
    }
    .cell.safe {
      background: linear-gradient(135deg, #002244, #33cc88);
      color: #ccffee;
    }
    .cell .inner {
      transform: scale(0);
      transition: transform 0.3s ease-out;
      z-index:5;
    }
    .cell.revealed .inner {
      transform: scale(1);
    }
    .history {
      margin-top:12px;
      max-height:300px;
      overflow:auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-radius:10px;
      padding:10px;
    }
    .history-item {
      display:flex;
      justify-content:space-between;
      padding:6px;
      border-radius:8px;
      margin-bottom:6px;
      transition: background 0.3s;
    }
    .history-item.win {
      background: linear-gradient(90deg, rgba(64,255,192,0.05), rgba(255,255,255,0.01));
    }
    .history-item.loss {
      background: linear-gradient(90deg, rgba(255,72,72,0.04), rgba(255,255,255,0.01));
    }
    .small { font-size:12px; color: var(--muted); }
    /* Plinko styles */
    .plinko-canvas {
      width: 100%;
      height: 500px;
      background: linear-gradient(180deg, #0b0d18 80%, #1a2a38 100%);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.7);
      display: block;
      margin: 0 auto;
      border: 1px solid rgba(255,255,255,0.04);
    }
    .plinko-payouts {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      gap: 2px;
    }
    .plinko-payout {
      flex: 1;
      text-align: center;
      font-weight: bold;
      color: var(--accent);
      background: rgba(255,255,255,0.03);
      border-radius: 6px;
      padding: 4px 0;
      font-size: 15px;
    }
    .plinko-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    .plinko-history {
      margin-top: 12px;
      max-height: 120px;
      overflow: auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.7);
    }
    .modal-content input {
      width: 100%;
    }
    .modal-content button {
      width: 100%;
    }
    .error-msg {
      color: #ff6666;
      font-size: 13px;
      text-align: center;
    }
    .switch-link {
      color: var(--accent);
      cursor: pointer;
      text-align: center;
      font-size: 13px;
    }
    .admin-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .admin-item span {
      flex: 1;
    }
    .admin-item input {
      width: 100px;
    }
    .admin-item button {
      padding: 6px 12px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <button class="switch-btn active" id="btnMines">Mines</button>
    <button class="switch-btn" id="btnPlinko">Plinko</button>
    <button class="switch-btn" id="adminBtn" style="display:none;">Admin</button>
    <button class="switch-btn" id="logoutBtn" style="display:none;">Logout</button>
  </div>
  <div class="container hidden" id="gameContainer">
    <!-- Mines Game -->
    <div class="card left-col" id="minesGame">
      <div class="balance">
        <div>
          <div class="label">Balance</div>
          <div class="amount" id="balanceDisplay">0</div>
        </div>
      </div>
      <div class="small muted" style="margin-top:8px;">
        Reveal tiles â€” avoid mines! Cash out before you explode.
      </div>
      <div class="grid" id="grid"></div>
      <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
        <button id="cashoutBtn" class="btn-primary" disabled>Cash Out</button>
        <div id="statusLabel" class="small"></div>
      </div>
    </div>
    <div class="card right-col" id="minesControls">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="flex:1">
          <div class="label small">Bet</div>
          <input type="number" id="betInput" min="1" step="1" value="1000" />
        </div>
        <div>
          <label class="toggle">
            <input type="number" id="mineCount" value="3" min="1" max="10" style="width:60px;" />
            <span class="small">Mines</span>
          </label>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button id="startBtn" class="btn-primary" style="flex:1;">Start Game</button>
        <label class="toggle">
          <input type="checkbox" id="autoCashout" />
          <span class="small">Auto Cashout</span>
        </label>
      </div>
      <div style="margin-top:12px; flex:1;">
        <div class="small muted">History</div>
        <div class="history" id="history"></div>
      </div>
    </div>
    <!-- Plinko Game -->
    <div class="card left-col hidden" id="plinkoGame">
      <div class="balance">
        <div>
          <div class="label">Balance</div>
          <div class="amount" id="plinkoBalanceDisplay">0</div>
        </div>
      </div>
      <div class="small muted" style="margin-top:8px;">
        Drop the ball! Where will it land?
      </div>
      <canvas class="plinko-canvas" id="plinkoCanvas" width="420" height="500"></canvas>
      <div class="plinko-payouts" id="plinkoPayouts"></div>
      <div class="plinko-controls">
        <div>
          <div class="label small">Bet</div>
          <input type="number" id="plinkoBetInput" min="1" step="1" value="1000" />
        </div>
        <button id="plinkoDropBtn" class="btn-primary">Drop Ball</button>
      </div>
      <div class="plinko-history" id="plinkoHistory"></div>
    </div>
    <div class="card right-col hidden" id="plinkoControls">
      <div class="small muted">Plinko Info</div>
      <div style="margin-top:10px;">
        <div class="small">Payouts increase as you go outwards. Middle slot pays 0.2x, next 0.5x, then 1x, 2x, and 10x at the edges.</div>
        <div class="small" style="margin-top:10px;">Try to hit the sides for big wins!</div>
      </div>
    </div>
  </div>
  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h2 style="text-align:center; color:var(--accent);">Login</h2>
      <input type="text" id="loginUsername" placeholder="Username" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button class="btn-primary" id="loginBtn">Login</button>
      <div class="error-msg" id="loginError"></div>
      <div class="switch-link" id="switchToRegister">Don't have an account? Register</div>
    </div>
  </div>
  <!-- Register Modal -->
  <div class="modal hidden" id="registerModal">
    <div class="modal-content">
      <h2 style="text-align:center; color:var(--accent);">Register</h2>
      <input type="text" id="registerUsername" placeholder="Username" />
      <input type="password" id="registerPassword" placeholder="Password" />
      <button class="btn-primary" id="registerBtn">Register</button>
      <div class="error-msg" id="registerError"></div>
      <div class="switch-link" id="switchToLogin">Already have an account? Login</div>
    </div>
  </div>
  <!-- Admin Modal -->
  <div class="modal hidden" id="adminModal">
    <div class="modal-content">
      <h2 style="text-align:center; color:var(--accent);">Admin Panel</h2>
      <div id="adminList" style="max-height:400px; overflow:auto;"></div>
      <button class="btn-primary" onclick="hideAdminModal()">Close</button>
      <div class="error-msg" id="adminError"></div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  // --- Supabase Setup ---
  const supabaseUrl = 'https://fbkilskrxglthluhohgg.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZia2lsc2tyeGdsdGhsdWhvaGdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDA3MTUsImV4cCI6MjA3NjI3NjcxNX0.lUrXiIQIDMB8ZqljZhmWXLsppUvOAd3ec7IJGvepkhQ';
  const FAKE_DOMAIN = '@spaceminesplinko.com';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // --- Shared Economy State ---
  const defaultState = {
    balance: 1000000,
    history: [],
    plinkoHistory: [],
    username: ''
  };
  let state = {...defaultState};
  let currentUser = null;

  async function loadState() {
    if (!currentUser) return;
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    if (error) {
      console.error('Error loading profile:', error);
      return;
    }
    if (data) {
      state.balance = data.balance ?? defaultState.balance;
      state.history = data.history ?? defaultState.history;
      state.plinkoHistory = data.plinko_history ?? defaultState.plinkoHistory;
      state.username = data.username;
    }
  }

  async function saveState() {
    if (!currentUser) return;
    const { error } = await supabase
      .from('profiles')
      .update({
        balance: state.balance,
        history: state.history,
        plinko_history: state.plinkoHistory
      })
      .eq('id', currentUser.id);
    if (error) {
      console.error('Error saving profile:', error);
    }
  }

  function fmt(n) {
    return n >= 1000 ? n.toLocaleString() : '' + n;
  }

  // --- Auth Modals ---
  const loginModal = document.getElementById('loginModal');
  const registerModal = document.getElementById('registerModal');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const switchToRegister = document.getElementById('switchToRegister');
  const switchToLogin = document.getElementById('switchToLogin');
  const loginError = document.getElementById('loginError');
  const registerError = document.getElementById('registerError');
  const logoutBtn = document.getElementById('logoutBtn');
  const gameContainer = document.getElementById('gameContainer');
  const adminBtn = document.getElementById('adminBtn');

  function showLogin() {
    loginModal.classList.remove('hidden');
    registerModal.classList.add('hidden');
  }

  function showRegister() {
    registerModal.classList.remove('hidden');
    loginModal.classList.add('hidden');
  }

  function hideModals() {
    loginModal.classList.add('hidden');
    registerModal.classList.add('hidden');
  }

  async function handleLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!username || !password) {
      loginError.textContent = 'Please fill in all fields';
      return;
    }
    const email = username + FAKE_DOMAIN;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      loginError.textContent = error.message;
      return;
    }
    currentUser = data.user;
    await loadState();
    hideModals();
    gameContainer.classList.remove('hidden');
    logoutBtn.style.display = 'block';
    if (state.username === 'burst') {
      adminBtn.style.display = 'block';
    }
    initGames();
  }

  async function handleRegister() {
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;
    if (!username || !password) {
      registerError.textContent = 'Please fill in all fields';
      return;
    }
    const email = username + FAKE_DOMAIN;
    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) {
      registerError.textContent = error.message;
      return;
    }
    const { error: profileError } = await supabase
      .from('profiles')
      .insert({
        id: data.user.id,
        username,
        balance: defaultState.balance,
        history: defaultState.history,
        plinko_history: defaultState.plinkoHistory
      });
    if (profileError) {
      registerError.textContent = profileError.message;
      return;
    }
    currentUser = data.user;
    await loadState();
    hideModals();
    gameContainer.classList.remove('hidden');
    logoutBtn.style.display = 'block';
    if (state.username === 'burst') {
      adminBtn.style.display = 'block';
    }
    initGames();
  }

  async function handleLogout() {
    await supabase.auth.signOut();
    currentUser = null;
    state = {...defaultState};
    logoutBtn.style.display = 'none';
    adminBtn.style.display = 'none';
    gameContainer.classList.add('hidden');
    showLogin();
    initGames();
  }

  loginBtn.onclick = handleLogin;
  registerBtn.onclick = handleRegister;
  switchToRegister.onclick = showRegister;
  switchToLogin.onclick = showLogin;
  logoutBtn.onclick = handleLogout;

  // --- Admin Modal ---
  const adminModal = document.getElementById('adminModal');
  const adminList = document.getElementById('adminList');
  const adminError = document.getElementById('adminError');

  function showAdminModal() {
    adminModal.classList.remove('hidden');
    renderAdmin();
  }

  function hideAdminModal() {
    adminModal.classList.add('hidden');
  }

  async function loadAllProfiles() {
    const { data, error } = await supabase.from('profiles').select('*');
    if (error) {
      adminError.textContent = error.message;
      return [];
    }
    return data;
  }

  async function renderAdmin() {
    adminList.innerHTML = '';
    const profiles = await loadAllProfiles();
    for (const p of profiles) {
      const item = document.createElement('div');
      item.className = 'admin-item';
      item.innerHTML = `
        <span>${p.username}: ${fmt(p.balance)}</span>
        <input type="number" id="bal_${p.id}" value="${p.balance}">
        <button class="btn-primary" onclick="setBalance('${p.id}')">Set</button>
      `;
      adminList.appendChild(item);
    }
  }

  window.setBalance = async (id) => {
    const newBal = Number(document.getElementById(`bal_${id}`).value);
    if (isNaN(newBal) || newBal < 0) {
      adminError.textContent = 'Invalid balance';
      return;
    }
    const { error } = await supabase.from('profiles').update({ balance: newBal }).eq('id', id);
    if (error) {
      adminError.textContent = error.message;
    } else {
      adminError.textContent = '';
      if (id === currentUser.id) {
        state.balance = newBal;
        renderBalance();
        renderPlinkoBalance();
      }
      renderAdmin();
    }
  };

  adminBtn.onclick = showAdminModal;

  // --- UI Switch ---
  const btnMines = document.getElementById('btnMines');
  const btnPlinko = document.getElementById('btnPlinko');
  const minesGame = document.getElementById('minesGame');
  const minesControls = document.getElementById('minesControls');
  const plinkoGame = document.getElementById('plinkoGame');
  const plinkoControls = document.getElementById('plinkoControls');

  function showGame(game) {
    if (game === 'mines') {
      minesGame.classList.remove('hidden');
      minesControls.classList.remove('hidden');
      plinkoGame.classList.add('hidden');
      plinkoControls.classList.add('hidden');
      btnMines.classList.add('active');
      btnPlinko.classList.remove('active');
      renderBalance();
    } else {
      minesGame.classList.add('hidden');
      minesControls.classList.add('hidden');
      plinkoGame.classList.remove('hidden');
      plinkoControls.classList.remove('hidden');
      btnMines.classList.remove('active');
      btnPlinko.classList.add('active');
      renderPlinkoBalance();
    }
  }
  btnMines.onclick = () => showGame('mines');
  btnPlinko.onclick = () => showGame('plinko');

  // --- Mines Game ---
  const balanceDisplay = document.getElementById('balanceDisplay');
  const betInput = document.getElementById('betInput');
  const startBtn = document.getElementById('startBtn');
  const mineCountInput = document.getElementById('mineCount');
  const autoCashout = document.getElementById('autoCashout');
  const gridEl = document.getElementById('grid');
  const cashoutBtn = document.getElementById('cashoutBtn');
  const statusLabel = document.getElementById('statusLabel');
  const historyEl = document.getElementById('history');

  function renderBalance() {
    balanceDisplay.textContent = fmt(state.balance);
  }

  function renderHistory() {
    historyEl.innerHTML = '';
    const items = state.history.slice().reverse();
    if (items.length === 0) {
      historyEl.innerHTML = `<div class="small muted">No history yet.</div>`;
      return;
    }
    for (const it of items) {
      const el = document.createElement('div');
      el.className = 'history-item ' + (it.profit >= 0 ? 'win' : 'loss');
      el.innerHTML = `
        <div>${it.result}</div>
        <div>${it.profit >= 0 ? '+' : ''}${fmt(it.profit)}</div>
      `;
      historyEl.appendChild(el);
    }
  }

  let game = null;
  function resetGame() {
    game = null;
    gridEl.innerHTML = '';
    cashoutBtn.disabled = true;
    statusLabel.textContent = '';
  }
  async function startGame() {
    resetGame();
    const bet = Math.floor(Number(betInput.value));
    if (!Number.isFinite(bet) || bet < 1) {
      alert('Enter a valid bet');
      return;
    }
    if (bet > state.balance) {
      alert('Not enough balance');
      return;
    }
    const mines = Math.floor(Number(mineCountInput.value));
    if (!Number.isFinite(mines) || mines < 1 || mines >= 25) {
      alert('Mines must be between 1 and 24');
      return;
    }
    const total = 25;
    const minePos = new Set();
    while (minePos.size < mines) {
      minePos.add(Math.floor(Math.random() * total));
    }
    game = { bet, mines, minePos, opened: new Set(), currentPayout: 0 };
    state.balance -= bet;
    await saveState();
    for (let i = 0; i < 25; i++) {
      const c = document.createElement('div');
      c.className = 'cell';
      c.dataset.idx = i;
      c.addEventListener('click', cellClick);
      const inner = document.createElement('div');
      inner.className = 'inner';
      c.appendChild(inner);
      gridEl.appendChild(c);
    }
    cashoutBtn.disabled = false;
    statusLabel.textContent = `Opened 0 safe / ${mines} mines`;
    renderBalance();
  }
  function cellClick(ev) {
    if (!game) return;
    const idx = +ev.currentTarget.dataset.idx;
    if (game.opened.has(idx)) return;
    game.opened.add(idx);
    const cell = ev.currentTarget;
    const inner = cell.querySelector('.inner');
    if (game.minePos.has(idx)) {
      cell.classList.add('revealed', 'mine');
      inner.textContent = 'ðŸ’£';
      endGame(false);
    } else {
      cell.classList.add('revealed', 'safe');
      inner.textContent = '';
      const safeCount = game.opened.size;
      statusLabel.textContent = `Opened ${safeCount} safe / ${game.mines} mines`;
      const multiplier = 1 + safeCount * 0.1;
      game.currentPayout = game.bet * multiplier;
      if (autoCashout.checked) {
        cashOut();
      }
    }
  }
  async function endGame(win) {
    for (const idx of game.minePos) {
      const c = gridEl.querySelector(`.cell[data-idx='${idx}']`);
      if (c && !c.classList.contains('revealed')) {
        c.classList.add('revealed', 'mine');
        c.querySelector('.inner').textContent = 'ðŸ’£';
      }
    }
    cashoutBtn.disabled = true;
    if (!win) {
      statusLabel.textContent = `ðŸ’¥ Boom! You lost -${fmt(game.bet)}`;
      state.history.push({ result: 'Loss', profit: -game.bet });
    }
    renderBalance();
    renderHistory();
    await saveState();
    game = null;
  }
  async function cashOut() {
    if (!game) return;
    const profit = Math.floor(game.currentPayout) - game.bet;
    state.balance += Math.floor(game.currentPayout);
    statusLabel.textContent = `Cashed out +${fmt(profit)}`;
    state.history.push({ result: 'Win', profit });
    await saveState();
    renderBalance();
    renderHistory();
    endGame(true);
  }
  startBtn.addEventListener('click', startGame);
  cashoutBtn.addEventListener('click', cashOut);

  // --- Plinko Game ---
  const plinkoBalanceDisplay = document.getElementById('plinkoBalanceDisplay');
  const plinkoBetInput = document.getElementById('plinkoBetInput');
  const plinkoDropBtn = document.getElementById('plinkoDropBtn');
  const plinkoCanvas = document.getElementById('plinkoCanvas');
  const plinkoPayouts = document.getElementById('plinkoPayouts');
  const plinkoHistory = document.getElementById('plinkoHistory');

  // Payouts: [left, ..., center, ..., right]
  const plinkoPayoutArr = [10, 2, 1, 0.5, 0.2, 0.5, 1, 2, 10];

  function renderPlinkoPayouts() {
    plinkoPayouts.innerHTML = '';
    for (let i = 0; i < plinkoPayoutArr.length; ++i) {
      const div = document.createElement('div');
      div.className = 'plinko-payout';
      div.textContent = plinkoPayoutArr[i] + 'x';
      plinkoPayouts.appendChild(div);
    }
  }

  function renderPlinkoBalance() {
    plinkoBalanceDisplay.textContent = fmt(state.balance);
  }

  function renderPlinkoHistory() {
    plinkoHistory.innerHTML = '';
    if (state.plinkoHistory.length === 0) {
      plinkoHistory.innerHTML = '<div>No history yet.</div>';
      return;
    }
    for (let i = state.plinkoHistory.length - 1; i >= 0; --i) {
      const h = state.plinkoHistory[i];
      const color = h.payout > 1 ? 'style="color:#7af0c2;"' : '';
      plinkoHistory.innerHTML += `<div ${color}>${h.result} (${h.payout}x) ${h.profit >= 0 ? '+' : ''}${fmt(h.profit)}</div>`;
    }
  }

  // Plinko physics
  const ROWS = 8;
  const COLS = plinkoPayoutArr.length;
  const PEG_RADIUS = 7;
  const BALL_RADIUS = 10;
  const SLOT_HEIGHT = 40;
  const PEG_Y_START = 60;
  const CANVAS_W = plinkoCanvas.width = 420; // Match column width
  const CANVAS_H = plinkoCanvas.height;
  const SLOT_W = CANVAS_W / COLS;

  let plinkoBall = null;
  let plinkoAnim = null;

  function resetPlinko() {
    plinkoBall = null;
    if (plinkoAnim) cancelAnimationFrame(plinkoAnim);
    drawPlinko();
  }

  async function dropPlinkoBall() {
    if (plinkoBall) return;
    const bet = Math.floor(Number(plinkoBetInput.value));
    if (!Number.isFinite(bet) || bet < 1) {
      alert('Enter a valid bet');
      return;
    }
    if (bet > state.balance) {
      alert('Not enough balance');
      return;
    }
    state.balance -= bet;
    await saveState();
    renderPlinkoBalance();

    plinkoBall = {
      x: CANVAS_W / 2,
      y: 30,
      vx: 0,
      vy: 2,
      bet: bet,
      path: [],
      finished: false
    };
    animatePlinko();
  }

  async function animatePlinko() {
    if (!plinkoBall) return;
    plinkoBall.vy += 0.08;
    plinkoBall.y += plinkoBall.vy;
    plinkoBall.x += plinkoBall.vx;

    for (let row = 0; row < ROWS; ++row) {
      const y = PEG_Y_START + row * SLOT_HEIGHT;
      if (Math.abs(plinkoBall.y - y) < PEG_RADIUS + BALL_RADIUS && !plinkoBall.path[row]) {
        let pegCount = COLS - (row % 2);
        for (let col = 0; col < pegCount; ++col) {
          let px = SLOT_W * (col + 0.5) + (row % 2 ? SLOT_W / 2 : 0);
          let py = y;
          let dx = plinkoBall.x - px;
          let dy = plinkoBall.y - py;
          let dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < PEG_RADIUS + BALL_RADIUS) {
            let dir = Math.random() < 0.5 ? -1 : 1;
            if (plinkoBall.x < px) dir = -1;
            if (plinkoBall.x > px) dir = 1;
            plinkoBall.vx = dir * (Math.random() * 2 + 1.5);
            plinkoBall.vy *= 0.7;
            plinkoBall.path[row] = true;
            break;
          }
        }
      }
    }

    if (plinkoBall.x < BALL_RADIUS) {
      plinkoBall.x = BALL_RADIUS;
      plinkoBall.vx = Math.abs(plinkoBall.vx) * 0.7;
    }
    if (plinkoBall.x > CANVAS_W - BALL_RADIUS) {
      plinkoBall.x = CANVAS_W - BALL_RADIUS;
      plinkoBall.vx = -Math.abs(plinkoBall.vx) * 0.7;
    }

    if (plinkoBall.y > CANVAS_H - 30) {
      let slot = Math.floor(plinkoBall.x / SLOT_W);
      slot = Math.max(0, Math.min(COLS - 1, slot));
      let payout = plinkoPayoutArr[slot];
      let profit = Math.floor(plinkoBall.bet * payout) - plinkoBall.bet;
      state.balance += Math.floor(plinkoBall.bet * payout);
      renderPlinkoBalance();
      let result = payout > 1 ? 'Win' : (payout === 1 ? 'Push' : 'Loss');
      state.plinkoHistory.push({ result, payout, profit });
      renderPlinkoHistory();
      await saveState();
      plinkoBall.finished = true;
      setTimeout(resetPlinko, 1200);
    }

    drawPlinko();
    if (!plinkoBall.finished) {
      plinkoAnim = requestAnimationFrame(animatePlinko);
    }
  }

  function drawPlinko() {
    const ctx = plinkoCanvas.getContext('2d');
    ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);

    for (let i = 0; i < COLS; ++i) {
      ctx.fillStyle = 'rgba(122,240,194,0.08)';
      ctx.fillRect(i * SLOT_W, CANVAS_H - 30, SLOT_W, 30);
    }

    ctx.font = 'bold 15px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#7af0c2';
    for (let i = 0; i < COLS; ++i) {
      ctx.fillText(plinkoPayoutArr[i] + 'x', i * SLOT_W + SLOT_W / 2, CANVAS_H - 10);
    }

    for (let row = 0; row < ROWS; ++row) {
      let pegCount = COLS - (row % 2);
      let y = PEG_Y_START + row * SLOT_HEIGHT;
      for (let col = 0; col < pegCount; ++col) {
        let x = SLOT_W * (col + 0.5) + (row % 2 ? SLOT_W / 2 : 0);
        ctx.beginPath();
        ctx.arc(x, y, PEG_RADIUS, 0, Math.PI * 2);
        ctx.fillStyle = '#fff3';
        ctx.fill();
        ctx.strokeStyle = '#7af0c2';
        ctx.lineWidth = 1;
        ctx.stroke();
      }
    }

    if (plinkoBall) {
      ctx.beginPath();
      ctx.arc(plinkoBall.x, plinkoBall.y, BALL_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = '#7af0c2';
      ctx.shadowColor = '#7af0c2';
      ctx.shadowBlur = 12;
      ctx.fill();
    }
  }

  plinkoDropBtn.onclick = dropPlinkoBall;

  // --- Initial Render ---
  async function initGames() {
    renderBalance();
    renderPlinkoBalance();
    renderHistory();
    renderPlinkoHistory();
    renderPlinkoPayouts();
    drawPlinko();
  }

  // --- Check session on load ---
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      currentUser = session.user;
      await loadState();
      hideModals();
      gameContainer.classList.remove('hidden');
      logoutBtn.style.display = 'block';
      if (state.username === 'burst') {
        adminBtn.style.display = 'block';
      }
      initGames();
      showGame('mines');
    } else {
      showLogin();
    }
  })();
})();
</script>
</body>
</html>
