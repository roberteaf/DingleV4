<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎮</text></svg>">
    <title>Game Hub - Flappy Bird, Casino, Messaging, Among Us</title>
    <!-- Firebase SDK for Casino and Messaging and Among Us -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, query, orderBy, limit, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, onValue, onChildAdded, onChildRemoved, set, push, remove } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
        window.firebase = { initializeApp, getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, query, orderBy, limit, deleteDoc, getStorage, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, getDatabase, ref, onValue, onChildAdded, onChildRemoved, set, push, remove };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #000000 0%, #001f3f 50%, #7b2cbf 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body.logged-in .screen {
            left: 300px;
            width: calc(100% - 300px);
        }
        
        body:not(.logged-in) .screen {
            left: 0;
            width: 100%;
        }
        
        .chat-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.8), rgba(123, 44, 191, 0.2));
            backdrop-filter: blur(10px);
            z-index: 5;
            display: none;
            flex-direction: column;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);
        }
        
        body.logged-in .chat-sidebar {
            display: flex;
        }
        
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .message {
            padding: 10px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            word-wrap: break-word;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .message small {
            opacity: 0.7;
            font-size: 0.8em;
            display: block;
            margin-bottom: 5px;
        }
        
        #chat-input-container {
            padding: 15px;
            border-top: 1px solid rgba(123, 44, 191, 0.3);
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex: 1;
            padding: 10px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(123, 44, 191, 0.3);
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }
        
        #chat-input:focus {
            outline: none;
            box-shadow: 0 0 10px #7b2cbf;
        }
        
        .screen {
            position: absolute;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: opacity 0.5s ease-in-out;
            z-index: 1;
        }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .header {
            width: 100%;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(123, 44, 191, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 10;
            position: relative;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header-left h1 {
            font-size: 1.8em;
            text-shadow: 0 0 10px #7b2cbf;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #7b2cbf; }
            to { text-shadow: 0 0 20px #7b2cbf, 0 0 30px #7b2cbf; }
        }
        
        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        
        .balance {
            font-size: 1.3em;
            padding: 8px 15px;
            background: linear-gradient(145deg, rgba(0, 31, 63, 0.9), rgba(123, 44, 191, 0.3));
            border-radius: 20px;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(123, 44, 191, 0.4);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            font-family: 'Roboto', sans-serif;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(123, 44, 191, 0.3));
            color: #ffffff;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(123, 44, 191, 0.5);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(123, 44, 191, 0.4));
        }
        
        .logout {
            background: linear-gradient(145deg, rgba(255, 0, 0, 0.3), rgba(123, 44, 191, 0.2)) !important;
        }
        
        .logout:hover {
            background: linear-gradient(145deg, rgba(255, 0, 0, 0.5), rgba(123, 44, 191, 0.3)) !important;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 900px;
            padding: 20px;
        }
        
        .game-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.6), rgba(123, 44, 191, 0.2));
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: all 0.4s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .game-card:hover::before {
            left: 100%;
        }
        
        .game-card:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: #7b2cbf;
            box-shadow: 0 12px 40px rgba(123, 44, 191, 0.6);
        }
        
        .game-icon {
            font-size: 4em;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px rgba(123, 44, 191, 0.5));
            transition: transform 0.3s ease;
        }
        
        .game-card:hover .game-icon {
            transform: scale(1.2);
        }
        
        .game-title {
            font-size: 1.4em;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .coming-soon {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .coming-soon:hover {
            transform: none;
            border-color: transparent;
            box-shadow: none;
        }
        
        .game-area {
            width: 100%;
            max-width: 800px;
            padding: 40px;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.7), rgba(123, 44, 191, 0.1));
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.6s ease-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .back-btn {
            align-self: flex-start;
            background: linear-gradient(145deg, rgba(123, 44, 191, 0.3), rgba(0, 0, 0, 0.5));
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        input, select {
            padding: 12px 18px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(123, 44, 191, 0.3);
            color: #fff;
            font-size: 1em;
            min-width: 80px;
        }
        
        input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 15px #7b2cbf;
            border-color: #7b2cbf;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .controls button {
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 15px;
            background: linear-gradient(145deg, rgba(0, 255, 0, 0.2), rgba(123, 44, 191, 0.3));
        }
        
        .result {
            font-size: 1.2em;
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            min-height: 20px;
        }
        
        .mine-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        
        .mine-cell {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(123, 44, 191, 0.2));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5em;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .mine-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(123, 44, 191, 0.5);
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(123, 44, 191, 0.3));
        }
        
        .mine-cell.boom {
            background: linear-gradient(145deg, #ff0000, #cc0000);
            animation: explode 0.5s ease;
            transform: scale(1.2);
        }
        
        .mine-cell.disabled {
            pointer-events: none;
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @keyframes explode {
            0% { transform: scale(1); }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .dice-display {
            font-size: 4em;
            margin: 20px 0;
            text-shadow: 0 0 10px #ffff00;
        }
        
        .tower-display {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 20px 0;
        }
        
        .tower-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .tower-cell {
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(123, 44, 191, 0.2));
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2em;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .tower-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(123, 44, 191, 0.5);
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(123, 44, 191, 0.3));
        }
        
        .tower-cell.revealed {
            pointer-events: none;
        }
        
        .tower-cell.safe {
            background: linear-gradient(145deg, #00ff00, #00cc00);
        }
        
        .tower-cell.skull {
            background: linear-gradient(145deg, #ff0000, #cc0000);
            animation: explode 0.5s ease;
        }
        
        .card-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .card {
            display: inline-block;
            background: linear-gradient(145deg, #001f3f, #7b2cbf);
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: flip 0.6s ease;
            min-width: 50px;
            text-align: center;
        }
        
        @keyframes flip {
            0% { transform: rotateY(0); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0); }
        }
        
        #crash-area {
            position: relative;
            height: 400px;
            width: 100%;
            background: linear-gradient(to top, #001f3f, #000);
            border-radius: 10px;
            overflow: hidden;
        }
        
        #rocket {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            transition: transform 0.1s ease-out;
            z-index: 2;
        }
        
        #multiplier {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            z-index: 2;
        }

        #countdown {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #ffff00;
            text-shadow: 0 0 10px #ffff00;
            z-index: 2;
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(0, 31, 63, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(123, 44, 191, 0.5);
            animation: slideInRight 0.5s ease-out;
            z-index: 1000;
            border-left: 4px solid #7b2cbf;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .coming-soon-content {
            text-align: center;
            font-size: 1.5em;
            opacity: 0.7;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(123, 44, 191, 0.3);
        }

        th {
            background: rgba(123, 44, 191, 0.2);
            font-weight: bold;
        }

        #cashout-btn, #cashout-btn-towers, #cashout-btn-crash {
            background: linear-gradient(145deg, rgba(255, 215, 0, 0.3), rgba(123, 44, 191, 0.3)) !important;
            padding: 12px 24px;
            font-size: 1em;
        }

        #cashout-btn:hover, #cashout-btn-towers:hover, #cashout-btn-crash:hover {
            background: linear-gradient(145deg, rgba(255, 215, 0, 0.5), rgba(123, 44, 191, 0.4)) !important;
        }

        .leaderboard {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .leaderboard h3 {
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #ffff00;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        #leaderboard {
            margin-top: 20px;
        }

        .auth-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-toggle .btn {
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .auth-form input, .auth-form select {
            width: 100%;
            margin-bottom: 15px;
        }

        .auth-form input[type="password"] {
            padding: 12px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(123, 44, 191, 0.3);
            color: #fff;
            font-size: 1em;
        }

        .auth-form input[type="password"]:focus {
            outline: none;
            box-shadow: 0 0 15px #7b2cbf;
            border-color: #7b2cbf;
        }

        /* Flappy Bird Styles */
        .random {
            height: 100vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        h3 {
            text-align: center;
            font-size: 2rem;
        }

        /* Messaging Styles from Chat Hub */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            opacity: 0.8;
            animation: twinkle 2s infinite alternate;
        }
        
        @keyframes twinkle {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }
        
        .shooting-stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            z-index: -1;
        }
        
        .shooting-stars span {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(255,255,255,0.1), 0 0 0 8px rgba(255,255,255,0.1), 0 0 20px rgba(255,255,255,0.1);
            animation: animateShooting 3s linear infinite;
        }
        
        .shooting-stars span::before {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            height: 1px;
            background: linear-gradient(90deg, #fff, transparent);
        }
        
        @keyframes animateShooting {
            0% {
                transform: rotate(315deg) translateX(0);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: rotate(315deg) translateX(-1000px);
                opacity: 0;
            }
        }
        
        .shooting-stars span:nth-child(1) {
            top: 0;
            right: 0;
            left: initial;
            animation-delay: 0s;
            animation-duration: 1s;
        }
        
        .shooting-stars span:nth-child(2) {
            top: 0;
            right: 80px;
            left: initial;
            animation-delay: 0.2s;
            animation-duration: 3s;
        }
        
        .shooting-stars span:nth-child(3) {
            top: 80px;
            right: 0;
            left: initial;
            animation-delay: 0.4s;
            animation-duration: 2s;
        }
        
        .shooting-stars span:nth-child(4) {
            top: 0;
            right: 180px;
            left: initial;
            animation-delay: 0.6s;
            animation-duration: 1.5s;
        }
        
        .shooting-stars span:nth-child(5) {
            top: 0;
            right: 400px;
            left: initial;
            animation-delay: 0.8s;
            animation-duration: 2.5s;
        }
        
        .shooting-stars span:nth-child(6) {
            top: 0;
            right: 600px;
            left: initial;
            animation-delay: 1s;
            animation-duration: 3s;
        }
        
        .shooting-stars span:nth-child(7) {
            top: 300px;
            right: 0;
            left: initial;
            animation-delay: 1.2s;
            animation-duration: 1.75s;
        }
        
        .shooting-stars span:nth-child(8) {
            top: 0;
            right: 700px;
            left: initial;
            animation-delay: 1.4s;
            animation-duration: 1.25s;
        }
        
        .shooting-stars span:nth-child(9) {
            top: 0;
            right: 1000px;
            left: initial;
            animation-delay: 0.75s;
            animation-duration: 2.25s;
        }
        
        .shooting-stars span:nth-child(10) {
            top: 0;
            right: 450px;
            left: initial;
            animation-delay: 2.75s;
            animation-duration: 2.75s;
        }
        
        .messaging-screen {
            position: absolute;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 1;
        }
        
        /* Add all messaging styles here from the original Chat Hub style tag */
        
        /* Among Us Styles */
        .among-game {
            position: relative;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .among-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .character {
            position: absolute;
        }

        .character-shadow {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
        }

        .character-sprite {
            background-size: cover;
        }

        .character-name-container {
            position: absolute;
            top: -20px;
            left: -50%;
            white-space: nowrap;
        }

        .character-name {
            font-size: 12px;
            color: white;
            text-shadow: 0 0 2px black;
        }

        .character-coins {
            font-size: 10px;
            color: gold;
        }

        .character-you-arrow {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: green;
        }

        .coin {
            position: absolute;
            background: gold;
            border-radius: 50%;
            animation: float 1s infinite alternate;
        }

        @keyframes float {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
    </style>
</head>
<body oncontextmenu="return false">
    <div id="chat-sidebar" class="chat-sidebar">
        <div id="messages"></div>
        <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
    
    <div id="login" class="screen visible">
        <div class="main-content">
            <div style="text-align: center; max-width: 400px;">
                <h1 style="font-size: 3em; margin-bottom: 30px;">Game Hub 🎮</h1>
                <div class="auth-toggle">
                    <button class="btn" onclick="setMode('login')">Login</button>
                    <button class="btn" onclick="setMode('signup')">Sign Up</button>
                </div>
                <div id="login-form" class="auth-form">
                    <input type="text" id="username" placeholder="Enter Username 👤" maxlength="20">
                    <select id="edition">
                        <option value="Bedrock">Bedrock Edition 🛏️</option>
                        <option value="Java">Java Edition ☕</option>
                    </select>
                    <input type="password" id="login-password" placeholder="Enter Password 🔒">
                    <button class="btn" onclick="login()" style="width: 100%; padding: 15px; font-size: 1.2em;">Login & Play 🎯</button>
                </div>
                <div id="signup-form" class="auth-form" style="display: none;">
                    <input type="text" id="signup-username" placeholder="Choose Username 👤" maxlength="20">
                    <select id="signup-edition">
                        <option value="Bedrock">Bedrock Edition 🛏️</option>
                        <option value="Java">Java Edition ☕</option>
                    </select>
                    <input type="password" id="signup-password" placeholder="Choose Password 🔒">
                    <input type="password" id="confirm-password" placeholder="Confirm Password 🔐">
                    <button class="btn" onclick="signUp()" style="width: 100%; padding: 15px; font-size: 1.2em;">Sign Up & Play 🎯</button>
                </div>
                <p style="margin-top: 20px; opacity: 0.7; font-family: 'Roboto', sans-serif;">Powered by Pixels & Bets ✨ | Now with Global Sync!</p>
            </div>
        </div>
    </div>
    
    <div id="dashboard" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <h1>Welcome, <span id="user"></span> (<span id="ed"></span>) 💎</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance">0.00</span> 💰 | Wins: <span id="wins">0</span> 🏆</div>
                <div class="header-buttons">
                    <button class="btn" onclick="showLeaderboard()">🏆 Leaderboard</button>
                    <button class="btn" onclick="deposit()">💳 Deposit</button>
                    <button class="btn" onclick="withdraw()">🏦 Withdraw</button>
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="games-grid">
                <div class="game-card" onclick="showScreen('flappy')">
                    <div class="game-icon">🕊️</div>
                    <h3 class="game-title">Flappy Bird</h3>
                </div>
                <div class="game-card" onclick="showScreen('mines')">
                    <div class="game-icon">💎💣</div>
                    <h3 class="game-title">Mines</h3>
                </div>
                <div class="game-card" onclick="showScreen('dice')">
                    <div class="game-icon">🎲🎲</div>
                    <h3 class="game-title">Dice</h3>
                </div>
                <div class="game-card" onclick="showScreen('towers')">
                    <div class="game-icon">🏗️</div>
                    <h3 class="game-title">Towers</h3>
                </div>
                <div class="game-card" onclick="showScreen('blackjack')">
                    <div class="game-icon">🃏</div>
                    <h3 class="game-title">Blackjack</h3>
                </div>
                <div class="game-card" onclick="showScreen('crash')">
                    <div class="game-icon">🚀</div>
                    <h3 class="game-title">Crash</h3>
                </div>
                <div class="game-card" onclick="showScreen('messaging')">
                    <div class="game-icon">💬</div>
                    <h3 class="game-title">Messaging</h3>
                </div>
                <div class="game-card" onclick="showScreen('among')">
                    <div class="game-icon">🧑‍🚀</div>
                    <h3 class="game-title">Among Us</h3>
                </div>
            </div>
            <div id="leaderboard" class="leaderboard" style="display: none;">
                <h3>Global Leaderboard 🏆</h3>
                <div id="lb-content"></div>
            </div>
        </div>
    </div>

    <div id="admin" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Admin Dashboard 🔧</h1>
            </div>
            <div class="header-right">
                <div class="balance">Admin Mode Active 👑</div>
                <div class="header-buttons">
                    <button class="btn" onclick="showAdminLogs()">📜 Admin Logs</button>
                    <button class="btn" onclick="downloadLog()">📥 Download Log</button>
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div style="max-width: 800px; width: 100%;">
                <h2 style="text-align: center; margin-bottom: 20px;">User Management</h2>
                <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <input type="text" id="userSearch" placeholder="Search users..." style="width: 300px; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid #7b2cbf; color: white;">
                    <button class="btn" onclick="loadUsers('')">Refresh 🔄</button>
                </div>
                <div id="usersTable" style="overflow-y: auto; max-height: 400px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px;"></div>
                <div style="margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px;">
                    <h3 style="margin: 0; flex-basis: 100%; text-align: center;">Adjust Balance for User</h3>
                    <input type="text" id="selectedUser" placeholder="Enter Username (e.g. NewUser)" style="width: 200px; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid #7b2cbf; color: white;">
                    <input type="text" id="adjustAmount" placeholder="Amount (e.g. 100k)" style="width: 150px; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid #7b2cbf; color: white;">
                    <button class="btn" onclick="doDeposit()" style="background: linear-gradient(145deg, rgba(0,255,0,0.3), rgba(0,200,0,0.2));">Deposit 💳</button>
                    <button class="btn" onclick="doWithdraw()" style="background: linear-gradient(145deg, rgba(255,0,0,0.3), rgba(200,0,0,0.2));">Withdraw 🏦</button>
                    <button class="btn" onclick="doDelete()" style="background: linear-gradient(145deg, rgba(255,0,0,0.3), rgba(200,0,0,0.2));">Delete 🗑️</button>
                </div>
                <div id="admin-logs" style="display: none; margin-top: 20px; overflow-y: auto; max-height: 400px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px;"></div>
            </div>
        </div>
    </div>
    
    <div id="mines-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Mines 💣</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-mines">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn" onclick="deposit()">💳 Deposit</button>
                    <button class="btn" onclick="withdraw()">🏦 Withdraw</button>
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="game-area">
                <div class="input-group">
                    <label>Bet: $</label>
                    <input type="text" id="minesbet" placeholder="10 or 1k" value="10">
                    <label>Mines:</label>
                    <select id="minesnum">
                        <option>1</option>
                        <option>3</option>
                        <option>5</option>
                    </select>
                    <button class="btn" onclick="startMines()">Start 🔍</button>
                </div>
                <div id="mine-grid" class="mine-grid"></div>
                <button id="cashout-btn" class="btn" onclick="cashOutMines()" style="display: none;">Cash Out 💰</button>
                <div id="mines-result" class="result"></div>
            </div>
        </div>
    </div>
    
    <div id="dice-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Dice 🎲</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-dice">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn" onclick="deposit()">💳 Deposit</button>
                    <button class="btn" onclick="withdraw()">🏦 Withdraw</button>
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="game-area">
                <div class="input-group">
                    <label>Bet: $</label>
                    <input type="text" id="dicebet" placeholder="10 or 1k" value="10">
                    <select id="dicechoice">
                        <option value="over">Over 7 (Win if >7)</option>
                        <option value="under">Under 7 (Win if <7)</option>
                    </select>
                    <button class="btn" onclick="playDice()">Roll 🎲</button>
                </div>
                <div id="dice-display" class="dice-display"></div>
                <div id="dice-result" class="result"></div>
            </div>
        </div>
    </div>
    
    <div id="towers-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Towers 🏗️</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-towers">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn" onclick="deposit()">💳 Deposit</button>
                    <button class="btn" onclick="withdraw()">🏦 Withdraw</button>
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="game-area">
                <div class="input-group">
                    <label>Bet: $</label>
                    <input type="text" id="towersbet" placeholder="10 or 1k" value="10">
                    <button class="btn" onclick="startTowers()">Build & Climb 🧗</button>
                </div>
                <div id="towers-display" class="tower-display"></div>
                <button id="cashout-btn-towers" class="btn" onclick="cashOutTowers()" style="display: none;">Cash Out 💰</button>
                <div id="towers-result" class="result"></div>
            </div>
        </div>
    </div>
    
    <div id="blackjack-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Blackjack 🃏</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-blackjack">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn" onclick="deposit()">💳 Deposit</button>
                    <button class="btn" onclick="withdraw()">🏦 Withdraw</button>
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="game-area">
                <div class="input-group">
                    <label>Bet: $</label>
                    <input type="text" id="bet" placeholder="10 or 1k" value="10">
                    <button class="btn" onclick="playBlackjack()">Deal Cards 🎴</button>
                </div>
                <div id="bj-hand-player" class="card-display"></div>
                <div style="text-align: center; margin: 10px 0;">vs</div>
                <div id="bj-hand-dealer" class="card-display"></div>
                <div class="controls">
                    <button class="btn" onclick="bjHit()">Hit ➡️</button>
                    <button class="btn" onclick="bjStand()">Stand 🛑</button>
                </div>
                <div id="bj-result" class="result"></div>
            </div>
        </div>
    </div>

    <div id="crash-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Crash 🚀</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-crash">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn" onclick="deposit()">💳 Deposit</button>
                    <button class="btn" onclick="withdraw()">🏦 Withdraw</button>
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="game-area">
                <div class="input-group" id="crash-input">
                    <label>Bet: $</label>
                    <input type="text" id="crashbet" placeholder="10 or 1k" value="10">
                    <button class="btn" onclick="betOnCrash()">Bet 🚀</button>
                </div>
                <div id="crash-area" style="display: none;">
                    <div id="countdown"></div>
                    <div id="rocket">🚀</div>
                    <div id="multiplier">1.00x</div>
                </div>
                <button id="cashout-btn-crash" class="btn" onclick="cashOutCrash()" style="display: none;">Cash Out 💰</button>
                <div id="crash-result" class="result"></div>
            </div>
        </div>
    </div>
    
    <!-- Flappy Bird Screen -->
    <div id="flappy-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Flappy Bird 🕊️</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-flappy">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="game-area">
                <h3>Flappy Bird Game</h3>
                <div class="random">
                    <canvas id="canvas" width="288" height="512"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Messaging Screen (Chat Hub) -->
    <div id="messaging-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Chat Hub 💬</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-messaging">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <section class="shooting-stars">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </section>
            
            <div id="messaging-dashboard" class="messaging-screen visible">
                <div class="main-content">
                    <div style="max-width: 800px; width: 100%;">
                        <h2 style="text-align: center; margin-bottom: 20px;">Users List</h2>
                        <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <input type="text" id="messaging-userSearch" placeholder="Search users..." style="width: 300px; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid #7b2cbf; color: white;">
                            <button class="btn" onclick="messagingLoadUsers('')">Refresh 🔄</button>
                        </div>
                        <div id="messaging-usersTable" style="overflow-y: auto; max-height: 400px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px;"></div>
                    </div>
                </div>
            </div>

            <div id="messaging-admin" class="messaging-screen hidden">
                <!-- Admin content from Chat Hub -->
                <div class="header">
                    <div class="header-left">
                        <button class="btn back-btn" onclick="messagingShowScreen('messaging-dashboard')">← Back</button>
                        <h1>Admin Dashboard 🔧</h1>
                    </div>
                    <div class="header-right">
                        <div class="balance">Admin Mode Active 👑</div>
                        <div class="header-buttons">
                            <button class="btn logout" onclick="logout()">🚪 Logout</button>
                        </div>
                    </div>
                </div>
                <div class="main-content">
                    <div style="max-width: 800px; width: 100%;">
                        <h2 style="text-align: center; margin-bottom: 20px;">User Management</h2>
                        <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <input type="text" id="messaging-adminUserSearch" placeholder="Search users..." style="width: 300px; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid #7b2cbf; color: white;">
                            <button class="btn" onclick="messagingLoadAdminUsers('')">Refresh 🔄</button>
                        </div>
                        <div id="messaging-adminUsersTable" style="overflow-y: auto; max-height: 400px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px;"></div>
                        <div style="margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px;">
                            <h3 style="margin: 0; flex-basis: 100%; text-align: center;">Manage User</h3>
                            <input type="text" id="messaging-selectedUser" placeholder="Enter Username (e.g. NewUser)" style="width: 200px; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid #7b2cbf; color: white;">
                            <button class="btn" onclick="messagingDoDelete()" style="background: linear-gradient(145deg, rgba(255,0,0,0.3), rgba(200,0,0,0.2));">Delete 🗑️</button>
                            <button class="btn" onclick="messagingDoBan()" style="background: linear-gradient(145deg, rgba(255,0,0,0.3), rgba(200,0,0,0.2));">Ban 🚫</button>
                            <button class="btn" onclick="messagingDoUnban()" style="background: linear-gradient(145deg, rgba(0,255,0,0.3), rgba(0,200,0,0.2));">Unban ✅</button>
                        </div>
                        <h2 style="text-align: center; margin: 20px 0;">Private Messages</h2>
                        <div id="messaging-private-chats-list" style="overflow-y: auto; max-height: 400px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px;"></div>
                        <div id="messaging-private-chat-view" style="margin-top: 20px; display: none; overflow-y: auto; max-height: 400px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px;"></div>
                    </div>
                </div>
            </div>

            <div id="messaging-private-chat-screen" class="messaging-screen hidden">
                <div class="header">
                    <div class="header-left">
                        <button class="btn back-btn" onclick="messagingClosePrivateChat()">← Back</button>
                        <h1>Chat with <span id="messaging-chat-with"></span> 💬</h1>
                    </div>
                    <div class="header-right">
                        <div class="header-buttons">
                            <button class="btn logout" onclick="logout()">🚪 Logout</button>
                        </div>
                    </div>
                </div>
                <div class="main-content">
                    <div class="chat-area">
                        <div id="messaging-private-messages"></div>
                        <div id="messaging-private-chat-input-container">
                            <input type="text" id="messaging-private-chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') messagingSendPrivateMessage()">
                            <input type="file" id="messaging-image-upload" accept="image/*" style="display: none;" onchange="messagingSendImageMessage()">
                            <button class="btn media-btn" onclick="document.getElementById('messaging-image-upload').click()">📷</button>
                            <button class="btn media-btn" onclick="messagingStartVoiceRecording()">🎤</button>
                            <button class="btn" onclick="messagingSendPrivateMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Among Us Screen -->
    <div id="among-screen" class="screen hidden">
        <div class="header">
            <div class="header-left">
                <button class="btn back-btn" onclick="showScreen('dashboard')">← Back</button>
                <h1>Among Us 🧑‍🚀</h1>
            </div>
            <div class="header-right">
                <div class="balance">Balance: $<span id="balance-among">0.00</span> 💰</div>
                <div class="header-buttons">
                    <button class="btn logout" onclick="logout()">🚪 Logout</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="game-area">
                <div class="input-group">
                    <input type="text" id="room-name" placeholder="Enter Room Name for Lobby">
                    <button class="btn" onclick="joinRoom()">Join Lobby</button>
                </div>
                <div class="among-game">
                    <div class="among-container" id="among-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification"></div>

    <script>
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        document.addEventListener('keydown', function(e) {
            if (e.keyCode === 123) {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0)) {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode === 'C'.charCodeAt(0)) {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode === 'J'.charCodeAt(0)) {
                e.preventDefault();
            }
            if (e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)) {
                e.preventDefault();
            }
        });
    </script>

    <script type="module">
        // Firebase Config - Use your own!
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };
        
        const { initializeApp, getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, query, orderBy, limit, deleteDoc, getStorage, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, getDatabase, ref, onValue, onChildAdded, onChildRemoved, set, push, remove } = window.firebase;
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const realtimeDb = getDatabase(app);
        
        // Casino Code
        let currentUser = '';
        let currentEdition = '';
        let balance = 0.00;
        let wins = 0;
        let currentScreen = 'login';
        let isAdmin = false;
        let userDoc = null;
        let messagesUnsub = null;
        let leaderboardUnsub = null;
        let usersUnsub = null;
        let userUnsub = null;
        let logsUnsub = null;
        
        // Game state variables (local for gameplay)
        let playerHand = [], dealerHand = [], bjBet = 0;
        let minesGrid = [], minesNum = 0, minesRevealed = 0, minesBet = 0, gameActive = false;
        let diceBet = 0;
        let towersGrid = [], currentTowerRow = 0, towersRevealed = 0, towersGameActive = false, towersBet = 0;
        let users = [];
        
        // Crash global state (local per tab for simplicity; could sync if needed)
        let globalCrashActive = false;
        let globalBettingActive = false;
        let globalStartTime;
        let globalLaunchTime;
        let globalCrashMultiplier;
        let globalCurrentMultiplier = 1.00;
        let userCrashBet = 0;
        let userCashedOut = false;
        
        const ADMIN_USERS = [
            { username: 'burst', password: 'burst123' },
            { username: '2metech77', password: '2metech77special' } // Special password for 2metech77; change as needed
        ];
        
        function formatBalance(bal) {
            if (bal >= 1e9) return (bal / 1e9).toFixed(1) + 'B';
            if (bal >= 1e6) return (bal / 1e6).toFixed(1) + 'M';
            if (bal >= 1e3) return (bal / 1e3).toFixed(1) + 'K';
            return bal.toFixed(2);
        }

        function parseBet(str) {
            str = str.toLowerCase().trim();
            let num = parseFloat(str);
            if (isNaN(num)) num = 0;
            if (str.includes('k')) num *= 1000;
            else if (str.includes('m')) num *= 1e6;
            else if (str.includes('b')) num *= 1e9;
            return num;
        }

        async function loadUserData() {
            try {
                if (!currentUser) return;
                const userRef = doc(db, 'users', currentUser);
                userDoc = userRef;
                if (userUnsub) userUnsub();
                userUnsub = onSnapshot(userRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if (!data.edition) {
                            updateDoc(userRef, { edition: currentEdition });
                            data.edition = currentEdition;
                        }
                        balance = data.balance || 0;
                        wins = data.wins || 0;
                        updateAllBalances();
                        document.getElementById('wins').textContent = wins;
                    } else {
                        showNotification('User data not found! ⚠️', 'error');
                    }
                });
                const adminUser = ADMIN_USERS.find(admin => admin.username === currentUser && currentEdition === 'Java');
                isAdmin = !!adminUser;
            } catch (error) {
                console.error('Load user data error:', error);
                showNotification('Failed to load user data! ⚠️', 'error');
            }
        }

        function updateAllBalances() {
            const formatted = formatBalance(balance);
            ['balance', 'balance-mines', 'balance-dice', 'balance-towers', 'balance-blackjack', 'balance-crash', 'balance-flappy', 'balance-messaging', 'balance-among'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = formatted;
            });
        }

        function updateUserWins(newWins) {
            wins = newWins;
            document.getElementById('wins').textContent = wins;
            if (userDoc) {
                updateDoc(userDoc, { wins: newWins });
            }
        }

        function updateUserBalance(newBalance, isWin = false) {
            balance = newBalance;
            updateAllBalances();
            if (userDoc) {
                updateDoc(userDoc, { balance: newBalance });
                if (isWin) {
                    updateUserWins(wins + 1);
                }
            }
        }

        // Synced Chat
        function loadMessages() {
            if (messagesUnsub) messagesUnsub();
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            const q = query(collection(db, 'messages'), orderBy('time', 'asc'), limit(50));
            messagesUnsub = onSnapshot(q, (snapshot) => {
                messagesDiv.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `<small>${new Date(data.time.toDate()).toLocaleTimeString()} - ${data.username}</small><br>${data.text}`;
                    messagesDiv.appendChild(div);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !currentUser) return;
            await addDoc(collection(db, 'messages'), {
                text,
                username: currentUser,
                time: new Date()
            });
            input.value = '';
        }

        // Global Leaderboard (by wins)
        function showLeaderboard() {
            const lb = document.getElementById('leaderboard');
            if (lb.style.display === 'none') {
                lb.style.display = 'block';
                if (leaderboardUnsub) leaderboardUnsub();
                const q = query(collection(db, 'users'), orderBy('wins', 'desc'), limit(10));
                leaderboardUnsub = onSnapshot(q, (snapshot) => {
                    const content = document.getElementById('lb-content');
                    content.innerHTML = '';
                    let rank = 1;
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `<span>#${rank} ${data.edition || 'Bedrock'} ${doc.id}</span><span>🏆${data.wins} | $${formatBalance(data.balance)}</span>`;
                        content.appendChild(item);
                        rank++;
                    });
                });
            } else {
                lb.style.display = 'none';
                if (leaderboardUnsub) leaderboardUnsub();
            }
        }

        function loadUsers(filter = '') {
            if (usersUnsub) usersUnsub();
            users = [];
            const usersRef = collection(db, 'users');
            const q = query(usersRef, limit(100));
            usersUnsub = onSnapshot(q, (snap) => {
                users = [];
                snap.docs.forEach((d) => {
                    const data = d.data();
                    const username = d.id;
                    if (filter === '' || username.toLowerCase().includes(filter.toLowerCase())) {
                        users.push({ username, edition: data.edition || 'Unknown', balance: data.balance || 0, wins: data.wins || 0 });
                    }
                });
                renderUsersTable();
            });
        }

        function renderUsersTable() {
            const tableDiv = document.getElementById('usersTable');
            if (users.length === 0) {
                tableDiv.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">No users found.</p>';
                return;
            }
            let html = '<table>';
            html += '<tr><th>Username</th><th>Edition</th><th>Balance</th><th>Wins</th></tr>';
            users.forEach(user => {
                html += `<tr><td>${user.username}</td><td>${user.edition}</td><td>$${formatBalance(user.balance)}</td><td>${user.wins}</td></tr>`;
            });
            html += '</table>';
            tableDiv.innerHTML = html;
        }

        function showAdminLogs() {
            const logsDiv = document.getElementById('admin-logs');
            if (logsDiv.style.display === 'none') {
                logsDiv.style.display = 'block';
                if (logsUnsub) logsUnsub();
                const q = query(collection(db, 'adminLogs'), orderBy('time', 'desc'), limit(50));
                logsUnsub = onSnapshot(q, (snapshot) => {
                    let html = '<table><tr><th>Time</th><th>Type</th><th>User</th><th>Amount</th><th>By Admin</th></tr>';
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        html += `<tr><td>${new Date(data.time.toDate()).toLocaleString()}</td><td>${data.type}</td><td>${data.user}</td><td>$${formatBalance(data.amount)}</td><td>${data.by}</td></tr>`;
                    });
                    html += '</table>';
                    logsDiv.innerHTML = html;
                });
            } else {
                logsDiv.style.display = 'none';
                if (logsUnsub) logsUnsub();
            }
        }

        async function doDeposit() {
            const user = document.getElementById('selectedUser').value.trim();
            const amtStr = document.getElementById('adjustAmount').value;
            const amt = parseBet(amtStr);
            if (!user || isNaN(amt) || amt <= 0) {
                showNotification('Invalid input! ⚠️', 'error');
                return;
            }
            const userRef = doc(db, 'users', user);
            const userSnap = await getDoc(userRef);
            let newBal;
            if (!userSnap.exists()) {
                newBal = amt;
                await setDoc(userRef, { balance: newBal, wins: 0, edition: 'Bedrock' });
                showNotification(`Created & Deposited $${formatBalance(amt)} to ${user} 💳`, 'success');
            } else {
                const currentBal = userSnap.data().balance || 0;
                newBal = currentBal + amt;
                await updateDoc(userRef, { balance: newBal });
                showNotification(`Deposited $${formatBalance(amt)} to ${user}. New: $${formatBalance(newBal)} 💳`, 'success');
            }
            await addDoc(collection(db, 'adminLogs'), {
                type: 'deposit',
                user: user,
                amount: amt,
                time: new Date(),
                by: currentUser
            });
            document.getElementById('selectedUser').value = '';
            document.getElementById('adjustAmount').value = '';
            loadUsers(document.getElementById('userSearch').value);
        }

        async function doWithdraw() {
            const user = document.getElementById('selectedUser').value.trim();
            const amtStr = document.getElementById('adjustAmount').value;
            const amt = parseBet(amtStr);
            if (!user || isNaN(amt) || amt <= 0) {
                showNotification('Invalid input! ⚠️', 'error');
                return;
            }
            const userRef = doc(db, 'users', user);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                showNotification('User not found! ⚠️', 'error');
                return;
            }
            const currentBal = userSnap.data().balance || 0;
            if (amt > currentBal) {
                showNotification(`Insufficient balance for ${user}! Current: $${formatBalance(currentBal)} 🏦`, 'error');
                return;
            }
            const newBal = currentBal - amt;
            await updateDoc(userRef, { balance: newBal });
            await addDoc(collection(db, 'adminLogs'), {
                type: 'withdraw',
                user: user,
                amount: amt,
                time: new Date(),
                by: currentUser
            });
            showNotification(`Withdrew $${formatBalance(amt)} from ${user}. New: $${formatBalance(newBal)} 🏦`, 'success');
            document.getElementById('selectedUser').value = '';
            document.getElementById('adjustAmount').value = '';
            loadUsers(document.getElementById('userSearch').value);
        }

        async function doDelete() {
            const user = document.getElementById('selectedUser').value.trim();
            if (!user) {
                showNotification('Invalid input! ⚠️', 'error');
                return;
            }
            if (user === currentUser) {
                showNotification('Cannot delete your own account! ⚠️', 'error');
                return;
            }
            const userRef = doc(db, 'users', user);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                showNotification('User not found! ⚠️', 'error');
                return;
            }
            await deleteDoc(userRef);
            await addDoc(collection(db, 'adminLogs'), {
                type: 'delete',
                user: user,
                amount: 0, // No amount for delete, but keeping for consistency
                time: new Date(),
                by: currentUser
            });
            showNotification(`Deleted user ${user}! 🗑️`, 'success');
            document.getElementById('selectedUser').value = '';
            document.getElementById('adjustAmount').value = '';
            loadUsers(document.getElementById('userSearch').value);
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('visible');
                s.classList.add('hidden');
            });
            const target = document.getElementById(`${screen}-screen`) || document.getElementById(screen);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('visible');
                currentScreen = screen;
                if (screen !== 'login') {
                    updateAllBalances();
                    if (screen === 'dashboard') loadMessages();
                }
                if (screen === 'admin') {
                    loadUsers('');
                }
                if (screen === 'mines') {
                    resetMines();
                }
                if (screen === 'towers') {
                    resetTowers();
                }
                if (screen === 'blackjack') {
                    resetBlackjack();
                }
                if (screen === 'crash') {
                    resetCrash();
                    if (!globalBettingActive && !globalCrashActive) {
                        startBettingPhase();
                    }
                }
                if (screen === 'flappy') {
                    // Start Flappy if needed
                }
                if (screen === 'messaging') {
                    messagingShowScreen('messaging-dashboard');
                }
                if (screen === 'among') {
                    // Start Among Us lobby selection
                }
            }
        }

        function setMode(mode) {
            if (mode === 'signup') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'block';
            } else {
                document.getElementById('signup-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            }
        }

        async function signUp() {
            try {
                const username = document.getElementById('signup-username').value.trim();
                const edition = document.getElementById('signup-edition').value;
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('confirm-password').value;
                if (!username || !edition || !password || !confirm || password !== confirm) {
                    showNotification('Please fill all fields and ensure passwords match! ⚠️', 'error');
                    return;
                }
                const adminUser = ADMIN_USERS.find(admin => admin.username === username);
                if (adminUser) {
                    showNotification('Admin username cannot be registered! Use login. ⚠️', 'error');
                    return;
                }
                const userRef = doc(db, 'users', username);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    showNotification('User already exists! Please login instead. ⚠️', 'error');
                    return;
                }
                await setDoc(userRef, { balance: 0, wins: 0, edition: edition, password: password });
                currentUser = username;
                currentEdition = edition;
                localStorage.setItem('currentUser', currentUser);
                localStorage.setItem('currentEdition', currentEdition);
                await loadUserData();
                document.body.classList.add('logged-in');
                showScreen('dashboard');
                document.getElementById('user').textContent = currentUser;
                document.getElementById('ed').textContent = currentEdition;
                addAdminButton();
                loadMessages();
                showNotification(`Welcome, ${username}! Edition: ${edition} 🎮`, 'success');
                if (isAdmin) {
                    showNotification('Admin mode active! Access the Admin Panel 🔧', 'success');
                }
            } catch (error) {
                console.error('Sign up error:', error);
                showNotification('Sign up failed! Check console for details. ⚠️', 'error');
            }
        }

        async function login() {
            try {
                const username = document.getElementById('username').value.trim();
                const edition = document.getElementById('edition').value;
                const password = document.getElementById('login-password').value;
                if (!username || !edition || !password) {
                    showNotification('Please fill all fields! ⚠️', 'error');
                    return;
                }
                const userRef = doc(db, 'users', username);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    showNotification('User not found! Please sign up. ⚠️', 'error');
                    return;
                }
                const data = userSnap.data();
                if (data.edition && data.edition !== edition) {
                    showNotification('Edition mismatch! Logout and try again. ⚠️', 'error');
                    return;
                }
                let passwordMatch = false;
                const adminUser = ADMIN_USERS.find(admin => admin.username === username);
                if (adminUser) {
                    if (password === adminUser.password) {
                        passwordMatch = true;
                        if (!data.password) {
                            await updateDoc(userRef, { password: adminUser.password });
                        }
                    }
                } else {
                    passwordMatch = data.password === password;
                }
                if (!passwordMatch) {
                    showNotification('Incorrect password! ⚠️', 'error');
                    return;
                }
                currentUser = username;
                currentEdition = edition;
                localStorage.setItem('currentUser', currentUser);
                localStorage.setItem('currentEdition', currentEdition);
                await loadUserData();
                document.body.classList.add('logged-in');
                showScreen('dashboard');
                document.getElementById('user').textContent = currentUser;
                document.getElementById('ed').textContent = currentEdition;
                addAdminButton();
                loadMessages();
                showNotification(`Welcome back, ${username}! Edition: ${edition} 🎮`, 'success');
                if (isAdmin) {
                    showNotification('Admin mode active! Access the Admin Panel 🔧', 'success');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed! Check console for details. ⚠️', 'error');
            }
        }

        function logout() {
            if (messagesUnsub) messagesUnsub();
            if (leaderboardUnsub) leaderboardUnsub();
            if (usersUnsub) usersUnsub();
            if (userUnsub) userUnsub();
            if (logsUnsub) logsUnsub();
            const adminBtn = document.querySelector('.admin-btn');
            if (adminBtn) adminBtn.remove();
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentEdition');
            document.body.classList.remove('logged-in');
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('visible');
                s.classList.add('hidden');
            });
            document.getElementById('login').classList.remove('hidden');
            document.getElementById('login').classList.add('visible');
            document.getElementById('username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('signup-username').value = '';
            document.getElementById('signup-password').value = '';
            document.getElementById('confirm-password').value = '';
            currentUser = '';
            currentEdition = '';
            balance = 0;
            wins = 0;
            isAdmin = false;
            userDoc = null;
            showNotification('Logged out safely! 👋', 'info');
            currentScreen = 'login';
            document.getElementById('leaderboard').style.display = 'none';
            // Reset messaging and among if needed
        }

        function addAdminButton() {
            if (!isAdmin) return;
            const headerButtons = document.querySelector('#dashboard .header-buttons');
            if (headerButtons.querySelector('.admin-btn')) return;
            const adminBtn = document.createElement('button');
            adminBtn.className = 'btn admin-btn';
            adminBtn.textContent = 'Admin Panel 🔧';
            adminBtn.onclick = () => showScreen('admin');
            headerButtons.insertBefore(adminBtn, headerButtons.firstChild);
        }

        function showNotification(message, type = 'info') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.background = type === 'error' ? 'rgba(255,0,0,0.95)' : type === 'success' ? 'rgba(0,255,0,0.95)' : 'rgba(0,31,63,0.95)';
            notif.style.borderLeftColor = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#7b2cbf';
            notif.classList.add('notification');
            setTimeout(() => {
                notif.classList.remove('notification');
            }, 3000);
        }

        function deposit() {
            showNotification(`Contact Admin on Discord (ID: 1057661388157362277) to deposit! 📩 Provide amount & proof.`, 'info');
        }

        function withdraw() {
            if (balance <= 0) {
                showNotification('Insufficient balance! 💸', 'error');
                return;
            }
            showNotification(`Contact Admin on Discord (ID: 1057661388157362277) to withdraw $${formatBalance(balance)}! 🏦 Provide details.`, 'info');
        }

        function showComingSoon() {
            showNotification('Coming Soon! Stay tuned ⏳', 'info');
        }

        function downloadLog() {
            // Fallback to local if needed; could sync logs to Firestore
            showNotification('Logs synced to Firestore! Check console for export. 📊', 'info');
            console.log('Full user data:', users);
        }

        // Reset functions (unchanged)
        function resetBlackjack() {
            playerHand = [];
            dealerHand = [];
            bjBet = 0;
            document.getElementById('bj-hand-player').innerHTML = '';
            document.getElementById('bj-hand-dealer').innerHTML = '';
            document.getElementById('bj-result').textContent = '';
            document.querySelectorAll('#blackjack-screen .controls button').forEach(btn => btn.disabled = false);
        }

        function resetMines() {
            gameActive = false;
            minesRevealed = 0;
            document.getElementById('cashout-btn').style.display = 'none';
            document.getElementById('mine-grid').innerHTML = '';
            document.getElementById('mines-result').textContent = '';
        }

        function resetTowers() {
            towersGameActive = false;
            currentTowerRow = 0;
            towersRevealed = 0;
            document.getElementById('cashout-btn-towers').style.display = 'none';
            document.getElementById('towers-display').innerHTML = '';
            document.getElementById('towers-result').textContent = '';
        }

        function resetCrash() {
            const inputGroup = document.getElementById('crash-input');
            if (inputGroup) inputGroup.style.display = 'flex';
            document.getElementById('crash-area').style.display = 'block';
            document.getElementById('cashout-btn-crash').style.display = 'none';
            document.getElementById('crash-result').textContent = '';
            const rocket = document.getElementById('rocket');
            if (rocket) {
                rocket.innerHTML = '🚀';
                rocket.style.transform = 'translateX(-50%) translateY(0px)';
            }
            userCrashBet = 0;
            userCashedOut = false;
            globalBettingActive = false;
            globalCrashActive = false;
        }

        // Game functions (updated to use updateUserBalance with win flag)
        function computeMinesMultiplier(revealed, mines) {
            const total = 25;
            const safe = total - mines;
            if (revealed === 0) return 1.0;
            let prob = 1.0;
            for (let i = 0; i < revealed; i++) {
                prob *= (safe - i) / (total - i);
            }
            return 1.0 / prob;
        }

        async function startMines() {
            const betStr = document.getElementById('minesbet').value;
            minesBet = parseBet(betStr);
            minesNum = parseInt(document.getElementById('minesnum').value);
            if (minesBet > balance || minesBet <= 0) {
                showNotification('Invalid bet! ⚠️', 'error');
                return;
            }
            updateUserBalance(balance - minesBet);
            
            minesGrid = Array(25).fill(false);
            for (let i = 0; i < minesNum; i++) {
                let pos;
                do { pos = Math.floor(Math.random() * 25); } while (minesGrid[pos]);
                minesGrid[pos] = true;
            }
            minesRevealed = 0;
            gameActive = true;
            renderMines();
            const multiplier = computeMinesMultiplier(minesRevealed, minesNum);
            document.getElementById('mines-result').textContent = `Revealed: ${minesRevealed}/${25 - minesNum} | Potential Payout: x${multiplier.toFixed(2)}`;
            document.getElementById('cashout-btn').style.display = 'block';
        }

        function renderMines() {
            const grid = document.getElementById('mine-grid');
            grid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.classList.add('mine-cell');
                cell.textContent = '?';
                cell.onclick = () => revealMine(i);
                grid.appendChild(cell);
            }
        }

        function revealMine(idx) {
            if (!gameActive) return;
            const cells = document.querySelectorAll('#mine-grid .mine-cell');
            const cell = cells[idx];
            cell.classList.add('disabled');
            if (minesGrid[idx]) {
                cell.textContent = '💣';
                cell.classList.add('boom');
                gameActive = false;
                document.getElementById('cashout-btn').style.display = 'none';
                endMines(false);
            } else {
                cell.textContent = '💎';
                minesRevealed++;
                const multiplier = computeMinesMultiplier(minesRevealed, minesNum);
                document.getElementById('mines-result').textContent = `Revealed: ${minesRevealed}/${25 - minesNum} | Potential Payout: x${multiplier.toFixed(2)}`;
                if (minesRevealed === 25 - minesNum) {
                    gameActive = false;
                    document.getElementById('cashout-btn').style.display = 'none';
                    endMines(true);
                }
            }
        }

        function cashOutMines() {
            if (!gameActive) return;
            gameActive = false;
            document.getElementById('cashout-btn').style.display = 'none';
            const multiplier = computeMinesMultiplier(minesRevealed, minesNum);
            const payout = minesBet * multiplier;
            updateUserBalance(balance + payout, true);
            document.getElementById('mines-result').textContent += ` | Cashed out! +$${formatBalance(payout)} 💰`;
            document.querySelectorAll('.mine-cell').forEach(cell => cell.classList.add('disabled'));
        }

        function endMines(win) {
            if (win) {
                const multiplier = computeMinesMultiplier(minesRevealed, minesNum);
                const payout = minesBet * multiplier;
                updateUserBalance(balance + payout, true);
                document.getElementById('mines-result').textContent += ` | Win! +$${formatBalance(payout)} 🎉`;
            } else {
                document.getElementById('mines-result').textContent += ` | Boom! Loss 💥`;
            }
            document.querySelectorAll('.mine-cell').forEach(cell => cell.classList.add('disabled'));
        }

        async function playDice() {
            const betStr = document.getElementById('dicebet').value;
            diceBet = parseBet(betStr);
            const choice = document.getElementById('dicechoice').value;
            if (diceBet > balance || diceBet <= 0) {
                showNotification('Invalid bet! ⚠️', 'error');
                return;
            }
            updateUserBalance(balance - diceBet);
            
            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;
            const sum = die1 + die2;
            document.getElementById('dice-display').innerHTML = `🎲 ${die1} + 🎲 ${die2} = ${sum}`;
            
            let win = false;
            if (choice === 'over' && sum > 7) win = true;
            else if (choice === 'under' && sum < 7) win = true;
            else if (sum === 7) {
                updateUserBalance(balance + diceBet);
                document.getElementById('dice-result').textContent = `Push on 7! Refund: $${formatBalance(diceBet)} 💤`;
            }
            
            if (win) {
                const payout = diceBet * 2;
                updateUserBalance(balance + payout, true);
                document.getElementById('dice-result').textContent = `You win! 🎉 Payout: $${formatBalance(payout)}`;
            } else {
                document.getElementById('dice-result').textContent = `You lose! 😤`;
            }
        }

        async function startTowers() {
            const betStr = document.getElementById('towersbet').value;
            towersBet = parseBet(betStr);
            if (towersBet > balance || towersBet <= 0) {
                showNotification('Invalid bet! ⚠️', 'error');
                return;
            }
            updateUserBalance(balance - towersBet);
            
            towersGrid = [];
            for (let row = 0; row < 5; row++) {
                const rowCells = ['safe', 'safe', 'safe'];
                const skullPos = Math.floor(Math.random() * 3);
                rowCells[skullPos] = 'skull';
                towersGrid.push(rowCells);
            }
            currentTowerRow = 0;
            towersRevealed = 0;
            towersGameActive = true;
            renderTowers();
            document.getElementById('towers-result').textContent = 'Choose a cell in the bottom row to start climbing! Only one per row.';
            document.getElementById('cashout-btn-towers').style.display = 'block';
            updateTowerMultiplier();
        }

        function renderTowers() {
            const display = document.getElementById('towers-display');
            display.innerHTML = '';
            for (let r = 4; r >= 0; r--) {
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('tower-row');
                for (let c = 0; c < 3; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('tower-cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.textContent = '?';
                    cell.onclick = () => revealTowerCell(r, c);
                    rowDiv.appendChild(cell);
                }
                display.appendChild(rowDiv);
            }
            updateTowerRows();
        }

        function updateTowerRows() {
            const cells = document.querySelectorAll('.tower-cell');
            cells.forEach(cell => {
                const r = parseInt(cell.dataset.row);
                if (r < currentTowerRow) {
                    // Past rows already revealed
                } else if (r > currentTowerRow) {
                    cell.style.opacity = '0.5';
                    cell.style.pointerEvents = 'none';
                } else {
                    cell.style.opacity = '1';
                    cell.style.pointerEvents = 'auto';
                }
            });
        }

        function revealTowerCell(row, col) {
            if (row !== currentTowerRow || !towersGameActive) return;
            const cells = document.querySelectorAll('.tower-cell');
            const cell = Array.from(cells).find(c => parseInt(c.dataset.row) === row && parseInt(c.dataset.col) === col);
            if (!cell) return;
            cell.classList.add('revealed');
            if (towersGrid[row][col] === 'skull') {
                cell.textContent = '💀';
                cell.classList.add('skull');
                towersGameActive = false;
                document.getElementById('cashout-btn-towers').style.display = 'none';
                endTowers(false);
            } else {
                cell.textContent = '💎';
                cell.classList.add('safe');
                towersRevealed++;
                currentTowerRow++;
                if (currentTowerRow === 5) {
                    towersGameActive = false;
                    document.getElementById('cashout-btn-towers').style.display = 'none';
                    endTowers(true);
                    return;
                }
                updateTowerMultiplier();
                updateTowerRows();
            }
            const currentRowCells = Array.from(cells).filter(c => parseInt(c.dataset.row) === row);
            currentRowCells.forEach(c => {
                c.classList.add('revealed');
                c.style.pointerEvents = 'none';
            });
        }

        function updateTowerMultiplier() {
            const multiplier = 1 + 0.5 * towersRevealed;
            document.getElementById('towers-result').textContent = `Revealed: ${towersRevealed}/5 | Potential Payout: x${multiplier.toFixed(2)}`;
        }

        function cashOutTowers() {
            if (!towersGameActive) return;
            towersGameActive = false;
            document.getElementById('cashout-btn-towers').style.display = 'none';
            const multiplier = 1 + 0.5 * towersRevealed;
            const payout = towersBet * multiplier;
            updateUserBalance(balance + payout, true);
            document.getElementById('towers-result').textContent += ` | Cashed out! +$${formatBalance(payout)} 💰`;
            document.querySelectorAll('.tower-cell').forEach(c => c.style.pointerEvents = 'none');
        }

        function endTowers(win) {
            if (win) {
                const multiplier = 1 + 0.5 * 5;
                const payout = towersBet * multiplier;
                updateUserBalance(balance + payout, true);
                document.getElementById('towers-result').textContent += ` | Full climb! +$${formatBalance(payout)} 🎉`;
            } else {
                document.getElementById('towers-result').textContent += ` | Skull! Loss 💥`;
            }
            document.querySelectorAll('.tower-cell').forEach(c => c.style.pointerEvents = 'none');
        }

        // Blackjack (updated payouts)
        function handValue(hand) {
            let val = hand.reduce((a, c) => a + c.value, 0);
            let aces = hand.filter(c => c.rank === 'A').length;
            while (val > 21 && aces > 0) {
                val -= 10;
                aces--;
            }
            return val;
        }

        async function playBlackjack() {
            document.querySelectorAll('#blackjack-screen .controls button').forEach(btn => btn.disabled = false);
            document.getElementById('bj-hand-player').innerHTML = '';
            document.getElementById('bj-hand-dealer').innerHTML = '';
            document.getElementById('bj-result').textContent = '';
            playerHand = [];
            dealerHand = [];
            
            const betStr = document.getElementById('bet').value;
            bjBet = parseBet(betStr);
            if (bjBet > balance || bjBet <= 0) {
                showNotification('Invalid bet! ⚠️', 'error');
                return;
            }
            updateUserBalance(balance - bjBet);
            
            const suits = ['♠', '♥', '♦', '♣'];
            const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            function getCard() {
                const suit = suits[Math.floor(Math.random() * suits.length)];
                const rank = ranks[Math.floor(Math.random() * ranks.length)];
                const value = rank === 'A' ? 11 : ['J','Q','K'].includes(rank) ? 10 : parseInt(rank);
                return { rank, suit, value };
            }
            
            playerHand = [getCard(), getCard()];
            dealerHand = [getCard(), getCard()];
            
            document.getElementById('bj-hand-player').innerHTML = playerHand.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('');
            document.getElementById('bj-hand-dealer').innerHTML = `<span class="card">${dealerHand[0].rank}${dealerHand[0].suit}</span> <span class="card">?</span>`;
            
            document.getElementById('bj-result').textContent = `Hand Value: ${handValue(playerHand)}`;
        }

        function bjHit() {
            if (playerHand.length >= 5) return;
            const suits = ['♠', '♥', '♦', '♣'];
            const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            const suit = suits[Math.floor(Math.random() * suits.length)];
            const rank = ranks[Math.floor(Math.random() * ranks.length)];
            const value = rank === 'A' ? 11 : ['J','Q','K'].includes(rank) ? 10 : parseInt(rank);
            playerHand.push({ rank, suit, value });
            document.getElementById('bj-hand-player').innerHTML = playerHand.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('');
            const pv = handValue(playerHand);
            document.getElementById('bj-result').textContent = `Hand Value: ${pv}`;
            if (pv > 21) endBlackjack();
        }

        function bjStand() {
            while (handValue(dealerHand) < 17) {
                const suits = ['♠', '♥', '♦', '♣'];
                const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
                const suit = suits[Math.floor(Math.random() * suits.length)];
                const rank = ranks[Math.floor(Math.random() * ranks.length)];
                const value = rank === 'A' ? 11 : ['J','Q','K'].includes(rank) ? 10 : parseInt(rank);
                dealerHand.push({ rank, suit, value });
            }
            document.getElementById('bj-hand-dealer').innerHTML = dealerHand.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('');
            endBlackjack();
        }

        function endBlackjack() {
            const pv = handValue(playerHand);
            const dv = handValue(dealerHand);
            if (pv > 21) {
                document.getElementById('bj-result').textContent = `Bust! You lose. 😵 Dealer: ${dv}`;
            } else if (dv > 21) {
                updateUserBalance(balance + bjBet * 2, true);
                document.getElementById('bj-result').textContent = `Dealer busts! You win! 🎉 Payout: $${formatBalance(bjBet * 2)}`;
            } else if (pv > dv) {
                updateUserBalance(balance + bjBet * 2, true);
                document.getElementById('bj-result').textContent = `You win! 🎉 Payout: $${formatBalance(bjBet * 2)}`;
            } else if (pv === dv) {
                updateUserBalance(balance + bjBet);
                document.getElementById('bj-result').textContent = `Push! 💤 Refund: $${formatBalance(bjBet)}`;
            } else {
                document.getElementById('bj-result').textContent = `Dealer wins! 😤 Dealer: ${dv}`;
            }
            document.querySelectorAll('#blackjack-screen .controls button').forEach(btn => btn.disabled = true);
        }

        // Crash (updated bet/payout)
        function startBettingPhase() {
            globalBettingActive = true;
            globalCrashActive = false;
            globalLaunchTime = Date.now() + 15000;
            document.getElementById('crash-area').style.display = 'block';
            document.getElementById('crash-input').style.display = 'flex';
            document.getElementById('multiplier').textContent = '1.00x';
            const rocket = document.getElementById('rocket');
            if (rocket) {
                rocket.style.transform = 'translateX(-50%) translateY(0px)';
            }
            document.getElementById('countdown').textContent = 'Launch in 15s';
            document.getElementById('cashout-btn-crash').style.display = 'none';
            updateCountdown();
        }

        function updateCountdown() {
            if (!globalBettingActive) return;
            const elapsed = (Date.now() - (globalLaunchTime - 15000)) / 1000;
            const remaining = 15 - elapsed;
            if (remaining <= 0) {
                launchRocket();
                return;
            }
            document.getElementById('countdown').textContent = `Launch in ${Math.ceil(remaining)}s`;
            requestAnimationFrame(updateCountdown);
        }

        function launchRocket() {
            globalBettingActive = false;
            globalCrashActive = true;
            globalStartTime = Date.now();
            const lambda = 0.05;
            const crashSeconds = -Math.log(1 - Math.random()) / lambda;
            globalCrashMultiplier = 1 + 0.01 * crashSeconds;
            document.getElementById('countdown').textContent = '';
            document.getElementById('crash-input').style.display = 'none';
            if (userCrashBet > 0 && !userCashedOut) {
                document.getElementById('cashout-btn-crash').style.display = 'block';
            }
            const rocket = document.getElementById('rocket');
            if (rocket) {
                rocket.style.transform = 'translateX(-50%) translateY(0px)';
            }
            updateGlobalCrash();
        }

        function updateGlobalCrash() {
            if (!globalCrashActive) return;
            const elapsed = (Date.now() - globalStartTime) / 1000;
            globalCurrentMultiplier = 1 + 0.01 * elapsed;
            document.getElementById('multiplier').textContent = globalCurrentMultiplier.toFixed(2) + 'x';
            const rocket = document.getElementById('rocket');
            if (rocket) {
                rocket.style.transform = `translateX(-50%) translateY(${-elapsed * 50}px)`;
            }
            if (globalCurrentMultiplier >= globalCrashMultiplier) {
                globalCrash();
                return;
            }
            requestAnimationFrame(updateGlobalCrash);
        }

        function globalCrash() {
            globalCrashActive = false;
            const elapsed = (Date.now() - globalStartTime) / 1000;
            globalCurrentMultiplier = 1 + 0.01 * elapsed;
            document.getElementById('multiplier').textContent = globalCurrentMultiplier.toFixed(2) + 'x';
            const rocket = document.getElementById('rocket');
            if (rocket) {
                rocket.innerHTML = '💥';
                rocket.style.transform += ' scale(2)';
            }
            if (userCrashBet > 0 && !userCashedOut) {
                document.getElementById('crash-result').textContent = `Crashed at ${globalCurrentMultiplier.toFixed(2)}x! Lost $${formatBalance(userCrashBet)} 😵`;
                userCrashBet = 0;
            }
            document.getElementById('cashout-btn-crash').style.display = 'none';
            setTimeout(() => {
                const rocket = document.getElementById('rocket');
                if (rocket) {
                    rocket.innerHTML = '🚀';
                    rocket.style.transform = 'translateX(-50%) translateY(0px)';
                }
                document.getElementById('crash-result').textContent = `Crashed at ${globalCurrentMultiplier.toFixed(2)}x! Next round soon...`;
                setTimeout(() => {
                    startBettingPhase();
                }, 2000);
            }, 3000);
        }

        async function betOnCrash() {
            const betStr = document.getElementById('crashbet').value;
            const betAmount = parseBet(betStr);
            if (betAmount > balance || betAmount <= 0 || userCrashBet > 0) {
                showNotification('Invalid bet or already bet this round! ⚠️', 'error');
                return;
            }
            if (!globalBettingActive) {
                showNotification('Bets closed! Wait for next round. ⚠️', 'error');
                return;
            }
            updateUserBalance(balance - betAmount);
            userCrashBet = betAmount;
            userCashedOut = false;
            document.getElementById('cashout-btn-crash').style.display = 'block';
            showNotification(`Bet $${formatBalance(userCrashBet)} on crash! Cash out anytime. 🚀`, 'success');
        }

        function cashOutCrash() {
            if (userCrashBet <= 0 || userCashedOut || !globalCrashActive) return;
            userCashedOut = true;
            const payout = userCrashBet * globalCurrentMultiplier;
            updateUserBalance(balance + payout, true);
            document.getElementById('crash-result').textContent = `Cashed out at ${globalCurrentMultiplier.toFixed(2)}x! +$${formatBalance(payout)} 💰`;
            document.getElementById('cashout-btn-crash').style.display = 'none';
            userCrashBet = 0;
            showNotification(`Cashed out successfully! 🎉`, 'success');
        }

        // Automatically create/update admin users on load
        async function ensureAdminUsers() {
            const admins = [
                { username: 'burst', password: 'burst123', edition: 'Java' },
                { username: '2metech77', password: '2metech77special', edition: 'Java' }
            ];
            for (const admin of admins) {
                const userRef = doc(db, 'users', admin.username);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        balance: 0,
                        wins: 0,
                        edition: admin.edition,
                        password: admin.password
                    });
                    console.log(`Created admin user ${admin.username}`);
                } else {
                    const data = userSnap.data();
                    if (data.edition !== admin.edition || data.password !== admin.password) {
                        await updateDoc(userRef, {
                            edition: admin.edition,
                            password: admin.password
                        });
                        console.log(`Updated admin user ${admin.username} to Java edition and correct password`);
                    }
                }
            }
        }

        // Search listener
        document.addEventListener('DOMContentLoaded', () => {
            ensureAdminUsers().catch(console.error); // Automatically create/update admins on page load

            const searchInput = document.getElementById('userSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    loadUsers(e.target.value);
                });
            }
            // Auto-login check
            const storedUser = localStorage.getItem('currentUser');
            const storedEdition = localStorage.getItem('currentEdition');
            if (storedUser && storedEdition) {
                currentUser = storedUser;
                currentEdition = storedEdition;
                document.getElementById('user').textContent = currentUser;
                document.getElementById('ed').textContent = currentEdition;
                document.body.classList.add('logged-in');
                const adminUser = ADMIN_USERS.find(admin => admin.username === currentUser);
                isAdmin = !!adminUser && currentEdition === 'Java';
                loadUserData();
                addAdminButton();
                showScreen('dashboard');
                loadMessages();
                if (isAdmin) {
                    showNotification('Admin mode active! Access the Admin Panel 🔧', 'success');
                }
            }
            // Create stars for messaging, if needed
            const starsContainer = document.createElement('div');
            starsContainer.className = 'stars';
            document.body.insertBefore(starsContainer, document.body.firstChild);
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                const size = Math.random() * 3 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDelay = `${Math.random() * 2}s`;
                star.style.opacity = Math.random() * 0.5 + 0.5;
                starsContainer.appendChild(star);
            }
            // For messaging search
            const messagingSearchInput = document.getElementById('messaging-userSearch');
            if (messagingSearchInput) {
                messagingSearchInput.addEventListener('input', (e) => {
                    messagingLoadUsers(e.target.value);
                });
            }
            const messagingAdminSearchInput = document.getElementById('messaging-adminUserSearch');
            if (messagingAdminSearchInput) {
                messagingAdminSearchInput.addEventListener('input', (e) => {
                    messagingLoadAdminUsers(e.target.value);
                });
            }
            // Flappy Bird code
            const cvs = document.getElementById("canvas");
            const ctx = cvs.getContext("2d");

            const birdImg = new Image();
            birdImg.src = "https://raw.githubusercontent.com/Codewithrandom/FlappyBird/main/images/bird.png"; // Assume assets
            const bgImg = new Image();
            bgImg.src = "https://raw.githubusercontent.com/Codewithrandom/FlappyBird/main/images/bg.png";
            const fgImg = new Image();
            fgImg.src = "https://raw.githubusercontent.com/Codewithrandom/FlappyBird/main/images/fg.png";
            const pipeNorthImg = new Image();
            pipeNorthImg.src = "https://raw.githubusercontent.com/Codewithrandom/FlappyBird/main/images/pipeNorth.png";
            const pipeSouthImg = new Image();
            pipeSouthImg.src = "https://raw.githubusercontent.com/Codewithrandom/FlappyBird/main/images/pipeSouth.png";

            const flySound = new Audio();
            flySound.src = "https://raw.githubusercontent.com/Codewithrandom/FlappyBird/main/sounds/fly.mp3";
            const scorSound = new Audio();
            scorSound.src = "https://raw.githubusercontent.com/Codewithrandom/FlappyBird/main/sounds/score.mp3";

            let gap = 85;
            let constant;
            let bX = 10;
            let bY = 150;
            let gravity = 1.5;
            let score = 0;

            document.addEventListener("keydown", moveUp);

            function moveUp() {
              bY -= 25;
              flySound.play();
            }

            let pipe = [];

            pipe[0] = {
              x: cvs.width,
              y: 0,
            };

            function drawFlappy() {
              ctx.drawImage(bgImg, 0, 0);

              for (let i = 0; i < pipe.length; i++) {
                constant = pipeNorthImg.height + gap;
                ctx.drawImage(pipeNorthImg, pipe[i].x, pipe[i].y);
                ctx.drawImage(pipeSouthImg, pipe[i].x, pipe[i].y + constant);

                pipe[i].x--;

                if (pipe[i].x == 125) {
                  pipe.push({
                    x: cvs.width,
                    y: Math.floor(Math.random() * pipeNorthImg.height) - pipeNorthImg.height,
                  });
                }

                if (
                  bX + birdImg.width >= pipe[i].x &&
                  bX <= pipe[i].x + pipeNorthImg.width &&
                  (bY <= pipe[i].y + pipeNorthImg.height ||
                    bY + birdImg.height >= pipe[i].y + constant) ||
                  bY + birdImg.height >= cvs.height - fgImg.height
                ) {
                  location.reload();
                }

                if (pipe[i].x == 5) {
                  score++;
                  scorSound.play();
                }
              }

              ctx.drawImage(fgImg, 0, cvs.height - fgImg.height);

              ctx.drawImage(birdImg, bX, bY);

              bY += gravity;

              ctx.fillStyle = "#000";
              ctx.font = "20px Verdana";
              ctx.fillText("Score : " + score, 10, cvs.height - 20);

              requestAnimationFrame(drawFlappy);
            }

            // Call drawFlappy when flappy screen is shown
            if (currentScreen === 'flappy') {
                drawFlappy();
            }

            // Messaging Code from Chat Hub
            let messagingCurrentUser = '';
            let messagingCurrentScreen = 'messaging-dashboard';
            let messagingIsAdmin = false;
            let messagingUserDoc = null;
            let messagingUsersUnsub = null;
            let messagingAdminUsersUnsub = null;
            let messagingUserUnsub = null;
            let messagingPrivateMessagesUnsub = null;
            let messagingPrivateChatsUnsub = null;
            let messagingActiveChats = [];
            let messagingCurrentPrivateChatUser = '';
            let messagingListeners = {};
            let messagingUsers = [];
            let messagingAdminUsers = [];
            let messagingMediaRecorder = null;
            
            const messagingBadWords = ['fuck', 'shit', 'bitch', 'asshole', 'bastard', 'damn', 'cock', 'cunt', 'ass', 'arse', 'bollocks', 'bugger', 'bloody', 'wank', 'piss', 'twat', 'quim', 'nigger', 'fag', 'retard', 'crap', 'pussy', 'dick', 'prick', 'wanker', 'bellend', 'knob', 'tosser'];
            
            const messagingEmojis = ['👍', '❤️', '😂', '😢', '😡'];

            function messagingGetChatId(user1, user2) {
                return [user1, user2].sort().join('_');
            }

            function messagingCensorText(text) {
                let censored = text;
                messagingBadWords.forEach(word => {
                    const regex = new RegExp(word, 'gi');
                    censored = censored.replace(regex, '*'.repeat(word.length));
                });
                return censored;
            }

            function messagingContainsBadWord(str) {
                const lowerStr = str.toLowerCase();
                return messagingBadWords.some(word => lowerStr.includes(word));
            }

            async function messagingLoadUserData() {
                try {
                    if (!messagingCurrentUser) return;
                    const userRef = doc(db, 'messagingUsers', messagingCurrentUser);
                    messagingUserDoc = userRef;
                    if (messagingUserUnsub) messagingUserUnsub();
                    messagingUserUnsub = onSnapshot(userRef, (snap) => {
                        if (snap.exists()) {
                            const data = snap.data();
                            if (data.banned) {
                                showNotification('You are banned! ⚠️', 'error');
                                logout();
                                return;
                            }
                            messagingActiveChats = data.activeChats || [];
                            messagingListenToActiveChats();
                        } else {
                            showNotification('User data not found! ⚠️', 'error');
                        }
                    });
                    const adminUser = ADMIN_USERS.find(admin => admin.username === messagingCurrentUser);
                    messagingIsAdmin = !!adminUser;
                } catch (error) {
                    console.error('Load user data error:', error);
                    showNotification('Failed to load user data! ⚠️', 'error');
                }
            }

            function messagingListenToActiveChats() {
                Object.keys(messagingListeners).forEach(key => messagingListeners[key]());
                messagingListeners = {};
                messagingActiveChats.forEach(otherUser => {
                    const chatId = messagingGetChatId(messagingCurrentUser, otherUser);
                    const q = query(collection(db, `privateMessages/${chatId}/messages`), orderBy('time', 'desc'), limit(1));
                    messagingListeners[otherUser] = onSnapshot(q, (snap) => {
                        if (!snap.empty) {
                            const msg = snap.docs[0].data();
                            if (msg.username !== messagingCurrentUser) {
                                showNotification(`New message from ${otherUser}! 💬`, 'success');
                            }
                        }
                    });
                });
            }

            function messagingLoadUsers(filter = '') {
                if (messagingUsersUnsub) messagingUsersUnsub();
                messagingUsers = [];
                const usersRef = collection(db, 'messagingUsers');
                const q = query(usersRef, limit(100));
                messagingUsersUnsub = onSnapshot(q, (snap) => {
                    messagingUsers = [];
                    snap.forEach((d) => {
                        const data = d.data();
                        const username = d.id;
                        if (username !== messagingCurrentUser && (filter === '' || username.toLowerCase().includes(filter.toLowerCase()))) {
                            messagingUsers.push({ username });
                        }
                    });
                    messagingRenderUsersTable();
                });
            }

            function messagingRenderUsersTable() {
                const tableDiv = document.getElementById('messaging-usersTable');
                if (messagingUsers.length === 0) {
                    tableDiv.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">No users found.</p>';
                    return;
                }
                let html = '<table>';
                html += '<tr><th>Username</th><th>Action</th></tr>';
                messagingUsers.forEach(user => {
                    html += `<tr><td>${user.username}</td><td><button class="btn" onclick="messagingOpenPrivateChat('${user.username}')">Message 💬</button></td></tr>`;
                });
                html += '</table>';
                tableDiv.innerHTML = html;
            }

            function messagingLoadAdminUsers(filter = '') {
                if (messagingAdminUsersUnsub) messagingAdminUsersUnsub();
                messagingAdminUsers = [];
                const usersRef = collection(db, 'messagingUsers');
                const q = query(usersRef, limit(100));
                messagingAdminUsersUnsub = onSnapshot(q, (snap) => {
                    messagingAdminUsers = [];
                    snap.forEach((d) => {
                        const data = d.data();
                        const username = d.id;
                        if (filter === '' || username.toLowerCase().includes(filter.toLowerCase())) {
                            messagingAdminUsers.push({ username, banned: data.banned || false });
                        }
                    });
                    messagingRenderAdminUsersTable();
                });
            }

            function messagingRenderAdminUsersTable() {
                const tableDiv = document.getElementById('messaging-adminUsersTable');
                if (messagingAdminUsers.length === 0) {
                    tableDiv.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">No users found.</p>';
                    return;
                }
                let html = '<table>';
                html += '<tr><th>Username</th><th>Banned</th></tr>';
                messagingAdminUsers.forEach(user => {
                    html += `<tr><td>${user.username}</td><td>${user.banned ? 'Yes' : 'No'}</td></tr>`;
                });
                html += '</table>';
                tableDiv.innerHTML = html;
            }

            function messagingLoadPrivateChats() {
                if (messagingPrivateChatsUnsub) messagingPrivateChatsUnsub();
                const chatsList = document.getElementById('messaging-private-chats-list');
                chatsList.innerHTML = '';
                messagingPrivateChatsUnsub = onSnapshot(collection(db, 'privateMessages'), (snap) => {
                    chatsList.innerHTML = '';
                    snap.forEach((d) => {
                        const chatId = d.id;
                        const [user1, user2] = chatId.split('_');
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `<span>Chat between ${user1} and ${user2}</span><button class="btn" onclick="messagingViewPrivateChat('${chatId}')">View 👀</button>`;
                        chatsList.appendChild(item);
                    });
                });
            }

            function messagingViewPrivateChat(chatId) {
                if (messagingPrivateMessagesUnsub) messagingPrivateMessagesUnsub();
                const viewDiv = document.getElementById('messaging-private-chat-view');
                viewDiv.style.display = 'block';
                viewDiv.innerHTML = '';
                const q = query(collection(db, `privateMessages/${chatId}/messages`), orderBy('time', 'asc'));
                messagingPrivateMessagesUnsub = onSnapshot(q, (snapshot) => {
                    viewDiv.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'message';
                        let content = `<small>${new Date(data.time.toDate()).toLocaleTimeString()} - ${data.username}</small><br>`;
                        if (data.text) content += data.text;
                        if (data.imageUrl) content += `<br><img src="${data.imageUrl}" alt="Image">`;
                        if (data.audioUrl) content += `<br><audio controls src="${data.audioUrl}"></audio>`;
                        div.innerHTML = content;
                        viewDiv.appendChild(div);
                    });
                    viewDiv.scrollTop = viewDiv.scrollHeight;
                });
            }

            async function messagingOpenPrivateChat(otherUser) {
                messagingCurrentPrivateChatUser = otherUser;
                document.getElementById('messaging-chat-with').textContent = otherUser;
                messagingShowScreen('messaging-private-chat');
                const chatId = messagingGetChatId(messagingCurrentUser, otherUser);
                if (!messagingActiveChats.includes(otherUser)) {
                    await updateDoc(messagingUserDoc, { activeChats: firebase.firestore.FieldValue.arrayUnion(otherUser) });
                    const otherRef = doc(db, 'messagingUsers', otherUser);
                    await updateDoc(otherRef, { activeChats: firebase.firestore.FieldValue.arrayUnion(messagingCurrentUser) });
                    messagingActiveChats.push(otherUser);
                    messagingListenToActiveChats();
                }
                messagingLoadPrivateMessages(chatId);
            }

            function messagingLoadPrivateMessages(chatId) {
                if (messagingPrivateMessagesUnsub) messagingPrivateMessagesUnsub();
                const messagesDiv = document.getElementById('messaging-private-messages');
                messagesDiv.innerHTML = '';
                const q = query(collection(db, `privateMessages/${chatId}/messages`), orderBy('time', 'asc'), limit(50));
                messagingPrivateMessagesUnsub = onSnapshot(q, (snapshot) => {
                    messagesDiv.innerHTML = '';
                    snapshot.forEach((d) => {
                        const data = d.data();
                        const div = document.createElement('div');
                        div.className = 'message';
                        let content = `<small>${new Date(data.time.toDate()).toLocaleTimeString()} - ${data.username}</small><br>`;
                        if (data.text) content += data.text;
                        if (data.imageUrl) content += `<br><img src="${data.imageUrl}" alt="Image">`;
                        if (data.audioUrl) content += `<br><audio controls src="${data.audioUrl}"></audio>`;
                        div.innerHTML = content;
                        const reactionsDiv = document.createElement('div');
                        reactionsDiv.className = 'reactions';
                        messagingEmojis.forEach(emoji => {
                            const span = document.createElement('span');
                            span.className = 'reaction';
                            span.textContent = emoji;
                            span.onclick = () => messagingReactToMessage(d.id, emoji, chatId);
                            reactionsDiv.appendChild(span);
                        });
                        const existingReactions = document.createElement('div');
                        if (data.reactions) {
                            data.reactions.forEach(r => {
                                const rSpan = document.createElement('span');
                                rSpan.textContent = `${r.emoji} ${r.count}`;
                                existingReactions.appendChild(rSpan);
                            });
                        }
                        div.appendChild(reactionsDiv);
                        div.appendChild(existingReactions);
                        messagesDiv.appendChild(div);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
            }

            async function messagingReactToMessage(messageId, emoji, chatId) {
                const msgRef = doc(db, `privateMessages/${chatId}/messages/${messageId}`);
                const msgSnap = await getDoc(msgRef);
                if (msgSnap.exists()) {
                    let reactions = msgSnap.data().reactions || [];
                    const existing = reactions.find(r => r.emoji === emoji);
                    if (existing) {
                        existing.count++;
                    } else {
                        reactions.push({emoji, count: 1});
                    }
                    await updateDoc(msgRef, { reactions });
                }
            }

            async function messagingSendPrivateMessage() {
                const input = document.getElementById('messaging-private-chat-input');
                let text = input.value.trim();
                if (!text || !messagingCurrentUser || !messagingCurrentPrivateChatUser) return;
                text = messagingCensorText(text);
                const chatId = messagingGetChatId(messagingCurrentUser, messagingCurrentPrivateChatUser);
                const messagesRef = collection(db, `privateMessages/${chatId}/messages`);
                await addDoc(messagesRef, {
                    text,
                    username: messagingCurrentUser,
                    time: new Date(),
                    reactions: []
                });
                input.value = '';
            }

            async function messagingSendImageMessage() {
                const input = document.getElementById('messaging-image-upload');
                const file = input.files[0];
                if (!file || !messagingCurrentUser || !messagingCurrentPrivateChatUser) return;
                const chatId = messagingGetChatId(messagingCurrentUser, messagingCurrentPrivateChatUser);
                const storageRef = ref(storage, `images/${chatId}/${Date.now()}_${file.name}`);
                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const imageUrl = await getDownloadURL(snapshot.ref);
                    const messagesRef = collection(db, `privateMessages/${chatId}/messages`);
                    await addDoc(messagesRef, {
                        imageUrl,
                        username: messagingCurrentUser,
                        time: new Date(),
                        reactions: []
                    });
                    input.value = '';
                } catch (error) {
                    console.error('Image upload error:', error);
                    showNotification('Failed to upload image! ⚠️', 'error');
                }
            }

            async function messagingStartVoiceRecording() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showNotification('Voice recording not supported! ⚠️', 'error');
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    messagingMediaRecorder = new MediaRecorder(stream);
                    const chunks = [];
                    messagingMediaRecorder.ondataavailable = e => chunks.push(e.data);
                    messagingMediaRecorder.onstop = async () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const chatId = messagingGetChatId(messagingCurrentUser, messagingCurrentPrivateChatUser);
                        const storageRef = ref(storage, `audio/${chatId}/${Date.now()}.webm`);
                        try {
                            const snapshot = await uploadBytes(storageRef, blob);
                            const audioUrl = await getDownloadURL(snapshot.ref);
                            const messagesRef = collection(db, `privateMessages/${chatId}/messages`);
                            await addDoc(messagesRef, {
                                audioUrl,
                                username: messagingCurrentUser,
                                time: new Date(),
                                reactions: []
                            });
                        } catch (error) {
                            console.error('Audio upload error:', error);
                            showNotification('Failed to upload audio! ⚠️', 'error');
                        }
                    };
                    messagingMediaRecorder.start();
                    showNotification('Recording started! 🎤 Click again to stop.', 'success');
                    document.querySelector('#messaging-private-chat-input-container .media-btn[onclick="messagingStartVoiceRecording()"]').onclick = messagingStopVoiceRecording;
                } catch (error) {
                    console.error('Voice recording error:', error);
                    showNotification('Failed to start recording! ⚠️', 'error');
                }
            }

            function messagingStopVoiceRecording() {
                if (messagingMediaRecorder) {
                    messagingMediaRecorder.stop();
                    messagingMediaRecorder.stream.getTracks().forEach(track => track.stop());
                    showNotification('Recording stopped! 🎤', 'success');
                    document.querySelector('#messaging-private-chat-input-container .media-btn[onclick="messagingStopVoiceRecording()"]').onclick = messagingStartVoiceRecording;
                }
            }

            function messagingClosePrivateChat() {
                if (messagingPrivateMessagesUnsub) messagingPrivateMessagesUnsub();
                messagingCurrentPrivateChatUser = '';
                messagingShowScreen('messaging-dashboard');
            }

            async function messagingDoDelete() {
                const user = document.getElementById('messaging-selectedUser').value.trim();
                if (!user) {
                    showNotification('Invalid input! ⚠️', 'error');
                    return;
                }
                if (user === messagingCurrentUser) {
                    showNotification('Cannot delete your own account! ⚠️', 'error');
                    return;
                }
                const userRef = doc(db, 'messagingUsers', user);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    showNotification('User not found! ⚠️', 'error');
                    return;
                }
                await deleteDoc(userRef);
                showNotification(`Deleted user ${user}! 🗑️`, 'success');
                document.getElementById('messaging-selectedUser').value = '';
                messagingLoadAdminUsers(document.getElementById('messaging-adminUserSearch').value);
            }

            async function messagingDoBan() {
                const user = document.getElementById('messaging-selectedUser').value.trim();
                if (!user) {
                    showNotification('Invalid input! ⚠️', 'error');
                    return;
                }
                if (user === messagingCurrentUser) {
                    showNotification('Cannot ban your own account! ⚠️', 'error');
                    return;
                }
                const userRef = doc(db, 'messagingUsers', user);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    showNotification('User not found! ⚠️', 'error');
                    return;
                }
                await updateDoc(userRef, { banned: true });
                showNotification(`Banned user ${user}! 🚫`, 'success');
                document.getElementById('messaging-selectedUser').value = '';
                messagingLoadAdminUsers(document.getElementById('messaging-adminUserSearch').value);
            }

            async function messagingDoUnban() {
                const user = document.getElementById('messaging-selectedUser').value.trim();
                if (!user) {
                    showNotification('Invalid input! ⚠️', 'error');
                    return;
                }
                const userRef = doc(db, 'messagingUsers', user);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    showNotification('User not found! ⚠️', 'error');
                    return;
                }
                await updateDoc(userRef, { banned: false });
                showNotification(`Unbanned user ${user}! ✅`, 'success');
                document.getElementById('messaging-selectedUser').value = '';
                messagingLoadAdminUsers(document.getElementById('messaging-adminUserSearch').value);
            }

            function messagingShowScreen(screen) {
                document.querySelectorAll('.messaging-screen').forEach(s => {
                    s.classList.remove('visible');
                    s.classList.add('hidden');
                });
                const target = document.getElementById(`${screen}`) || document.getElementById(screen);
                if (target) {
                    target.classList.remove('hidden');
                    target.classList.add('visible');
                    messagingCurrentScreen = screen;
                    if (screen !== 'login') {
                        if (screen === 'messaging-dashboard') {
                            messagingLoadUsers('');
                        }
                    }
                    if (screen === 'messaging-admin') {
                        messagingLoadAdminUsers('');
                        messagingLoadPrivateChats();
                    }
                }
            }

            // Among Us Code
            let amongPlayerId = '';
            let amongPlayers = {};
            let amongCoins = {};
            let amongPlayerElements = {};
            let amongCoinElements = {};
            let amongLastProcessedInput = 0;

            const amongPlayerColors = ['red', 'orange', 'yellow', 'green', 'purple'];
            const amongCoinTimeouts = [2, 3, 4, 5];
            const amongMapData = { // Define your map blocked spaces, min/max x/y
                minX: 0,
                minY: 0,
                maxX: 20, // Example grid
                maxY: 15,
                blockedSpaces: {
                    '5x5': true, // Example blocked
                    // Add more
                }
            };
            const amongGridSize = 48; // Example 16px * 3 scale

            function amongCreateName() {
                const prefix = randomFromArray([
                    'cool',
                    'super',
                    'awesome',
                    'brave',
                    'crazy'
                ]);
                const animal = randomFromArray([
                    'cat',
                    'dog',
                    'fox',
                    'monkey',
                    'lion'
                ]);
                return `${prefix} ${animal}`;
            }

            function randomFromArray(array) {
                return array[Math.floor(Math.random() * array.length)];
            }

            function getKeyString(x, y) {
                return `${x}x${y}`;
            }

            function getRandomSafeSpot() {
                let x = Math.floor(Math.random() * (amongMapData.maxX - amongMapData.minX + 1)) + amongMapData.minX;
                let y = Math.floor(Math.random() * (amongMapData.maxY - amongMapData.minY + 1)) + amongMapData.minY;
                while (amongMapData.blockedSpaces[getKeyString(x, y)]) {
                    x = Math.floor(Math.random() * (amongMapData.maxX - amongMapData.minX + 1)) + amongMapData.minX;
                    y = Math.floor(Math.random() * (amongMapData.maxY - amongMapData.minY + 1)) + amongMapData.minY;
                }
                return { x, y };
            }

            function isSolid(x, y) {
                const blockedNextSpace = amongMapData.blockedSpaces[getKeyString(x, y)];
                return (
                    blockedNextSpace ||
                    x >= amongMapData.maxX ||
                    x < amongMapData.minX ||
                    y >= amongMapData.maxY ||
                    y < amongMapData.minY
                );
            }

            function amongKeypressListener(keyCode, callback) {
                let lastKeyDownTime = 0;
                document.addEventListener('keydown', (e) => {
                    if (e.keyCode === keyCode) {
                        const now = Date.now();
                        if (now - lastKeyDownTime > 100) { // Debounce
                            callback();
                            lastKeyDownTime = now;
                        }
                    }
                });
            }

            function handleArrowPress(xChange = 0, yChange = 0) {
                const newX = amongPlayers[amongPlayerId].x + xChange;
                const newY = amongPlayers[amongPlayers[amongPlayerId].y + yChange;
                if (!isSolid(newX, newY)) {
                    amongPlayers[amongPlayerId].x = newX;
                    amongPlayers[amongPlayerId].y = newY;
                    if (xChange === 1) {
                        amongPlayers[amongPlayerId].direction = 'right';
                    }
                    if (xChange === -1) {
                        amongPlayers[amongPlayerId].direction = 'left';
                    }
                    amongAttemptGrabCoin(newX, newY);
                    set(ref(realtimeDb, `players/${amongPlayerId}`), amongPlayers[amongPlayerId]);
                }
            }

            function amongAttemptGrabCoin(x, y) {
                const key = getKeyString(x, y);
                if (amongCoins[key]) {
                    remove(ref(realtimeDb, `coins/${key}`));
                    amongPlayers[amongPlayerId].coins += 1;
                    set(ref(realtimeDb, `players/${amongPlayerId}/coins`), amongPlayers[amongPlayerId].coins);
                }
            }

            function amongPlaceCoin() {
                const { x, y } = getRandomSafeSpot();
                const coinRef = ref(realtimeDb, `coins/${getKeyString(x, y)}`);
                set(coinRef, { x, y });
                const duration = randomFromArray(amongCoinTimeouts) * 1000;
                setTimeout(amongPlaceCoin, duration);
            }

            function joinRoom() {
                const roomName = document.getElementById('room-name').value.trim();
                if (!roomName) {
                    showNotification('Enter a room name!', 'error');
                    return;
                }
                amongCurrentRoom = roomName;
                // Use roomName in paths, e.g., 'rooms/' + roomName + '/players'
                amongInitGame();
            }

            function amongInitGame() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        amongPlayerId = user.uid;
                        const playerRef = ref(realtimeDb, `rooms/${amongCurrentRoom}/players/${amongPlayerId}`);
                        const defaultPlayer = {
                            id: amongPlayerId,
                            name: amongCreateName(),
                            direction: 'right',
                            color: randomFromArray(amongPlayerColors),
                            x: 3,
                            y: 3,
                            coins: 0,
                        };
                        set(playerRef, defaultPlayer);
                        onValue(playerRef, (snapshot) => {
                            amongPlayers[amongPlayerId] = snapshot.val();
                        });
                        onValue(ref(realtimeDb, `rooms/${amongCurrentRoom}/players`), (snapshot) => {
                            const players = snapshot.val() || {};
                            Object.keys(players).forEach((key) => {
                                const characterState = players[key];
                                let el = amongPlayerElements[key];
                                if (!el) {
                                    el = document.createElement('div');
                                    el.classList.add('character', 'grid-cell');
                                    if (characterState.id === amongPlayerId) {
                                        el.classList.add('you');
                                    }
                                    el.innerHTML = `
                                        <div class="character-shadow grid-cell"></div>
                                        <div class="character-sprite grid-cell"></div>
                                        <div class="character-name-container">
                                            <span class="character-name"></span>
                                            <span class="character-coins">0</span>
                                        </div>
                                        <div class="character-you-arrow"></div>
                                    `;
                                    document.getElementById('among-container').appendChild(el);
                                    amongPlayerElements[key] = el;
                                }
                                el.querySelector('.character-name').innerText = characterState.name;
                                el.querySelector('.character-coins').innerText = characterState.coins;
                                el.setAttribute('data-color', characterState.color);
                                el.setAttribute('data-direction', characterState.direction);
                                const left = amongGridSize * characterState.x + 'px';
                                const top = amongGridSize * characterState.y - 4 + 'px';
                                el.style.transform = `translate3d(${left}, ${top}, 0)`;
                            });
                            // Remove disconnected players
                            Object.keys(amongPlayerElements).forEach((key) => {
                                if (!players[key]) {
                                    amongPlayerElements[key].parentNode.removeChild(amongPlayerElements[key]);
                                    delete amongPlayerElements[key];
                                }
                            });
                        });
                        onChildAdded(ref(realtimeDb, `rooms/${amongCurrentRoom}/coins`), (snapshot) => {
                            const coin = snapshot.val();
                            const key = getKeyString(coin.x, coin.y);
                            const coinEl = document.createElement('div');
                            coinEl.classList.add('coin', 'grid-cell');
                            coinEl.innerHTML = `
                                <div class="coin-shadow grid-cell"></div>
                                <div class="coin-sprite grid-cell"></div>
                            `;
                            const left = amongGridSize * coin.x + 'px';
                            const top = amongGridSize * coin.y - 4 + 'px';
                            coinEl.style.transform = `translate3d(${left}, ${top}, 0)`;
                            document.getElementById('among-container').appendChild(coinEl);
                            amongCoinElements[key] = coinEl;
                        });
                        onChildRemoved(ref(realtimeDb, `rooms/${amongCurrentRoom}/coins`), (snapshot) => {
                            const coin = snapshot.val();
                            const key = getKeyString(coin.x, coin.y);
                            amongCoinElements[key].parentNode.removeChild(amongCoinElements[key]);
                            delete amongCoinElements[key];
                        });
                        amongPlaceCoin();
                        amongKeypressListener(38, () => handleArrowPress(0, -1));  // Up
                        amongKeypressListener(40, () => handleArrowPress(0, 1));   // Down
                        amongKeypressListener(37, () => handleArrowPress(-1, 0));  // Left
                        amongKeypressListener(39, () => handleArrowPress(1, 0));   // Right
                    } else {
                        signInAnonymously(auth);
                    }
                });
            }

            // Enter key for login and chat
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && currentScreen === 'login') {
                    if (document.getElementById('signup-form').style.display !== 'none') {
                        signUp();
                    } else {
                        login();
                    }
                } else if (e.key === 'Enter' && document.body.classList.contains('logged-in')) {
                    sendMessage();
                }
            });
    </script>
</body>
</html>
